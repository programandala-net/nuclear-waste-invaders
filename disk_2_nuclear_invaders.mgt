( Nuclear Invaders )                                            \ Description                                                   \ This game is a ZX Spectrum port (for Solo Forth:              \ http://programandala.net/en.program.solo_forth.html) of a     \ game written by Dancresp in 2013 for Jupiter ACE              \ (http://www.zonadepruebas.com/viewtopic.php?t=4231).          \ This version:                                                 \ Copyright (C) 2016 Marcos Cruz (programandala.net)            \ Original version:                                             \ Copyright (C) 2013 Scainet Soft                               \ License                                                       \ You may do whatever you want with this work, so long as you   \ retain the copyright/authorship/acknowledgment/credit         \ notice(s) and this license in all redistributed copies and    \ derived works.  There is no warranty.                                                                                         ( Nuclear Invaders -- load block  )                             2 load                                                          locate nuclear-invaders                                         dup 1- last-locatable !                                         load                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( contains delimited located )                                  : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;       variable default-first-locatable  variable first-locatable      variable last-locatable  blk/disk 1- last-locatable !           : delimited  ( ca1 len1 -- ca2 len2 )                             dup 2+ dup allocate-string swap  ( ca1 len1 ca2 len2 )          2dup blank  2dup 2>r drop char+ smove 2r>  ;                  : located  ( ca len -- block | false )                            delimited  last-locatable @ 1+  first-locatable @               default-first-locatable @  first-locatable !                    do  0 i line>string 2over                                           contains if  2drop i unloop exit  then                          break-key? ?leave                                           loop  2drop false  ;                                          -->                                                                                                                             ( ?located locate from reneeded reneed )                        : ?located  ( block | 0 -- )  dup 0= #-268 ?throw  ;            : locate  ( "name" -- block | false )                             parse-name save-string located  ;                             : from  ( "name" -- )  locate ?located first-locatable !  ;     : reneeded  ( ca len -- )  located ?located load  ;             : reneed  ( "name" -- )  parse-name save-string reneeded  ;     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( needed-word [needed] [unneeded] needed need )                 2variable needed-word                                           : [needed]  ( "name" -- wf )                                      parse-name needed-word 2@ 2dup or                               if  compare 0=  exit  then  2drop 2drop true   ; immediate    : [unneeded]  ( "name" -- wf )                                    postpone [needed] 0=  ; immediate                             : needed  ( ca len -- )                                           needed-word 2@ 2>r                                              -trailing -leading save-string 2dup needed-word 2!              2dup undefined?                                                 if  reneeded  else  2drop  then  2r> needed-word 2!  ;        : need  ( "name" -- )  parse-name needed  ;                     blk @ 1+ dup default-first-locatable !  first-locatable !                                                                                                                                       ( alias )                                                       : alias  ( xt "name" -- )  defer latest name> defer!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( z80-asm, )                                                    only forth definitions                                          need ?pairs  need 3dup                                          : 8*   ( n1 -- n2 )  2* 2* 2*  ;                                : z80-asm,  ( -- )  assembler  ;                                also assembler definitions hex                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- registers )                                       0 constant b   1 constant c   2 constant d   3 constant e       4 constant h   5 constant l   6 constant m   7 constant a       0 constant bc  2 constant de  4 constant hl                     6 constant sp  6 constant af                                    DD constant ix-op  FD constant iy-op                            : ix  ( -- rphl )  ix-op c, hl  ;                               : iy  ( -- rphl )  iy-op c, hl  ;                               : ?page  ( n -- n )  dup 80 + FF swap u< #-269 ?throw  ;        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- defining words for z80 instructions)              : m1  ( 8b "name" -- )                                            create c, does>  ( -- )  ( pfa ) c@ c,  ;                     : m2  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ + c,  ;               : m3  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ swap 8* + c,  ;       : m4  ( 8b "name" -- )                                            create c, does>  ( 8b -- )  ( 8b pfa ) c@ c, c,  ;            : m5  ( 8b "name" -- )                                            create c, does>  ( 16b -- )  ( 16b pfa ) c@ c, ,  ;           : m6  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) CB c, c@ + c,  ;           -->                                                                                                                                                                                           ( z80-asm, -- defining words for z80 instructions)              : m7  ( 8b "name" -- )                                            create c, does>  ( r bit -- )                                     ( r bit pfa ) CB c, c@ swap 8* + + c,  ;                    : m8  ( 16b "name" -- )                                           create , does>  ( -- )  ( pfa ) @ ,  ;                        : m9  ( 8b "name" -- )                                            create c, does>  ( a -- )                                         ( a pfa )  c@ c, here 1+ - ?page c,  ;                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- defining words for z80 instructions)              : ma  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) c@ c, drop c,  ;                          : mb  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) CB c, c@ c, drop c,  ;                    : mc  ( 8b "name" -- )                                            create c, does>  ( disp rphl bit -- )                             ( disp rphl bit pfa )                                           CB c, c@ rot drop rot c, swap 8* + c,  ;                    -->                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- opcodes)                                          00 m1 nop, 02 m3 stap, 03 m3 incp, 04 m3 inc, 05 m3 dec, 07 m1  rlca, 08 m1 exaf, 09 m3 addp, 0A m3 ftap, 0B m3 decp, 0F m1     rrca, 10 m9 djnz, 17 m1 rla, 18 m9 jr,  1F m1 rra, 20 m9 jrnz,  22 m5 sthl, 27 m1 daa, 28 m9 jrz, 2A m5 fthl, 2F m1 cpl, 30 m9  jrnc, 32 m5 sta, 37 m1 scf, 38 m9 jrc, 3A m5 fta, 3F m1 ccf, 76 m1 halt, 80 m2 add, 88 m2 adc, 90 m2 sub, 98 m2 sbc, B8 m2 cp,  C1 m3 pop, C2 m5 jpnz, C3 m5 jp, C5 m3 push, C6 m4 add#, C7 m2  rst, C9 m1 ret, CA m5 jpz, CD m5 call, CE m4 adc#, D2           -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- opcodes)                                          m5 jpnc, D3 m4 out, 41 m3 outbc, D6 m4 sub#, D9 m1 exx, DA m5   jpc, DB m4 in, 40 m3 inbc, 0DE m4 sbc#, E2 m5 jppo, E3 m1       exsp, E6 m4 and#, E9 m1 jphl, EA m5 jppe, EB m1 exde, EE m4     xor#, F2 m5 jpp, F3 m1 di,  F6 m4 or#, F9 m1 ldsp, FA m5 jpm,   FB m1 ei, FE m4 cp#, 00 m6 rlc, 08 m6 rrc, 10 m6 rl, 18 m6      rr, 20 m6 sla,  28 m6 sra, 38 m6 srl,  40 m7 bit, 80 m7 res, C0 m7 set, B0ED m8 ldir, B8ED m8 lddr, 44ED m8 neg, 57ED m8 ldai,  47ED m8 ldia, 56ED m8 im1 5EED m8 im2 B1ED m8 cpir, 6FED m8     rld,                                                            -->                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- opcodes)                                          : jpix,  ( -- )  ix-op c, jphl,  ;                              : ldp#,  ( 16b rp -- )  8* 1+ c, ,  ;                           : ld#,  ( 8b r -- )  8* 06 + c, c,  ;                           : ld,  ( r1 r2 -- )  8* 40 + + c,  ;                            : sbcp,  ( rp -- )  ED c, 8* 42 + c,  ;                         : adcp,  ( rp1 rp2 -- )  ED c, 8* 4A + c,  ;                    : stp,  ( a rp -- )  ED c, 8* 43 + c, ,  ;                      : ftp,  ( a rp -- )  ED c, 8* 4B + c, ,  ;                      : addix,  ( rp -- )  ix-op c, addp,  ;                          : addiy,  ( rp -- )  iy-op c, addp,  ;                          : clr,  ( rp -- )  0 swap ldp#,  ;                              : ldp,  ( rp1 rp2 -- )  2dup ld, 1+ swap 1+ swap ld,  ;         CF m4 hook, \ rst 0x08                                          D7 m1 prt,  \ rst 0x16                                          -->                                                             ( z80-asm, -- index register opcodes)                           86 ma addx, 8E ma adcx, 96 ma subx, 9E ma sbcx, A6 ma andx,     AE ma xorx, B6 ma orx,  BE ma cpx,  34 ma incx, 35 ma decx,     06 mb rlcx, 0E mb rrcx, 16 mb rlx,  1E mb rrx,  26 mb slax,     2E mb srax, 3E mb srlx, 46 mc bitx, 86 mc resx, C6 mc setx,     : ftx,   ( disp rpi r -- )   nip 8* 46 + c, c,  ;               : stx,   ( r disp rphl -- )  drop swap 70 + c, c,  ;            : st#x,  ( 8b disp rpi -- )  drop 36 c, swap c, c,  ;           : ftpx,  ( disp rpi rp -- )  3dup 1+ ftx, rot 1+ -rot ftx,  ;   : stpx,  ( disp rpi rp -- )  3dup 1+ stx, rot 1+ -rot stx,  ;   -->                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- conditions)                                       C2 constant z  CA constant nz D2 constant cy DA constant nc     E2 constant pe EA constant po F2 constant ne  FA constant p     : jp>jr  ( op1 -- op2 )  dup nc > #-273 ?throw  A2 -  ;         -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- conditional ret and call)                         : ?ret,  ( op -- )  8 xor 2- c,  ;                              : retc,  ( -- )  cy ?ret,  ;    : retnc,  ( -- )  nc ?ret,  ;   : retz,  ( -- )  z ?ret,  ;     : retnz,  ( -- )  nz ?ret,  ;   : retm,  ( -- )  ne ?ret,  ;     : retp,  ( -- )  p ?ret,  ;    : retpe,  ( -- )  pe ?ret,  ;   : retpo,  ( -- )  po ?ret,  ;   : ?call,  ( a op -- )  8 xor 2+ c, ,  ;                         : callc,  ( -- )  cy ?call, ;                                   : callnc,  ( -- )  nc ?call,  ;                                 : callz,  ( -- )  z ?call, ;                                    : callnz,  ( -- )  nz ?call,  ;                                 : callm,  ( -- )  ne ?call, ;                                   : callp,  ( -- )  p ?call,  ;                                   : callpe,  ( -- )  pe ?call, ;                                  : callpo, ( -- )  po ?call,  ;                                  -->                                                             ( z80-asm, -- control structures with relative jumps)           : >relmark  ( -- orig )  here 1-  ;                             : relresolve  ( orig dest -- )  1- over - ?page swap c!  ;      : >relresolve  ( orig -- )  here relresolve  ;                  : <relresolve  ( dest -- )  here 1- swap relresolve  ;          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- control structures with relative jumps)           : ahead  ( -- orig  )  18 , >relmark  ;                         : rif  ( op -- orig cs-id )  jp>jr , >relmark 0A  ;             : rthen  ( orig cs-id -- )  0A ?pairs >relresolve  ;            : relse  ( orig cs-id -- cs-id ) \ XXX TODO document              0A ?pairs 18 rif rot swap rthen 0A  ;                         : rbegin  (  -- dest cs-id )  <mark 0B  ;                       : rwhile  (  op -- orig cs-id )  jp>jr rif 2+  ;                : runtil  (  dest cs-id op -- )  , 0B ?pairs <relresolve  ;     : ragain  (  dest cs-id -- )  18 runtil  ;                      : rrepeat  (  dest cs-id1 orig cs-id2 )                           2swap ragain 2- rthen  ;                                      : rstep    ( dest cs-id -- )  10 runtil  ;  -->                                                                                                                                                                                                                 ( z80-asm, -- control structures with absolute jumps)           : aif  (  op -- orig cs-id )  c, >mark 08  ;                    : athen  (  orig cs-id -- )  08 ?pairs >resolve  ;              : aelse  (  cs-id -- cs-id )                                      08 ?pairs C3 aif rot swap athen 08  ;                         : abegin  (  -- dest cs-id )  <mark 09  ;                       : awhile  (  op -- orig cs-id )  aif 2+  ;                      : auntil  (  cs-id op -- )  c, 09 ?pairs <resolve  ;            : aagain  (  cs-id -- )  C3 auntil  ;                           : arepeat  (  dest cs-id1 orig cs-id2 )                           2swap aagain 2- athen  ;                                      : |mark  ( -- a )  here 2-  ;                                   : |resolve  ( a -- )  |mark swap !  ;                           -->                                                                                                                                                                                             ( z80-asm, -- last opcodes and macros)                          A0 m2 and,  B0 m2 or,  A8 m2 xor,                               : subp,  ( rp -- )  a and sbcp,  ;                              : tstp,  ( rp -- )  dup a ld, 1+ or,  ;                         -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm, -- unresolved macro endm )                           6 cells allocate-string                                         : unresolved  ( n -- a )  cells [ dup ] literal +  ;  drop      only forth definitions also assembler                           : macro  ( "name" -- )  : asm  ;                                : endm  ( -- )  end-asm postpone ;  ;  immediate                decimal only forth                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( z80-asm )                                                     \ Z80 assembler for Solo Forth                                  only forth definitions                                          need ?pairs  need 3dup                                          : 8*   ( n1 -- n2 )  2* 2* 2*  ;                                : z80-asm  ( -- )  assembler  ;                                 also assembler definitions hex                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- registers )                                        0 constant b   1 constant c   2 constant d   3 constant e       4 constant h   5 constant l   6 constant m   7 constant a       0 constant bc  2 constant de  4 constant hl                     6 constant sp  6 constant af                                    DD constant ix-op  FD constant iy-op                            : ix  ( -- rphl )  ix-op c, hl  ;                               : iy  ( -- rphl )  iy-op c, hl  ;                               : ?page  ( n -- n )  dup 80 + FF swap u< #-269 ?throw  ;        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- defining words for z80 instructions)               : m1  ( 8b "name" -- )                                            create c, does>  ( -- )  ( pfa ) c@ c,  ;                     : m2  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ + c,  ;               : m3  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ swap 8* + c,  ;       : m4  ( 8b "name" -- )                                            create c, does>  ( 8b -- )  ( 8b pfa ) c@ c, c,  ;            : m5  ( 8b "name" -- )                                            create c, does>  ( 16b -- )  ( 16b pfa ) c@ c, ,  ;           : m6  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) CB c, c@ + c,  ;           -->                                                                                                                                                                                           ( z80-asm -- defining words for z80 instructions)               : m7  ( 8b "name" -- )                                            create c, does>  ( r bit -- )                                     ( r bit pfa ) CB c, c@ swap 8* + + c,  ;                    : m8  ( 16b "name" -- )                                           create , does>  ( -- )  ( pfa ) @ ,  ;                        : m9  ( 8b "name" -- )                                            create c, does>  ( a -- )                                         ( a pfa )  c@ c, here 1+ - ?page c,  ;                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- defining words for z80 instructions)               : ma  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) c@ c, drop c,  ;                          : mb  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) CB c, c@ c, drop c,  ;                    : mc  ( 8b "name" -- )                                            create c, does>  ( disp rphl bit -- )                             ( disp rphl bit pfa )                                           CB c, c@ rot drop rot c, swap 8* + c,  ;                    -->                                                                                                                                                                                                                                                                                                                             ( z80-asm -- opcodes)                                           00 m1 nop 02 m3 stap 03 m3 incp 04 m3 inc 05 m3 dec 07 m1 rlca  08 m1 exaf 09 m3 addp 0A m3 ftap 0B m3 decp 0F m1 rrca 10 m9    djnz 17 m1 rla 18 m9 jr  1F m1 rra 20 m9 jrnz 22 m5 sthl 27 m1  daa 28 m9 jrz 2A m5 fthl 2F m1 cpl 30 m9 jrnc 32 m5 sta 37 m1   scf 38 m9 jrc 3A m5 fta 3F m1 ccf 76 m1 halt 80 m2 add 88 m2    adc 90 m2 sub 98 m2 sbc B8 m2 cp C1 m3 pop C2 m5 jpnz C3 m5 jp  C5 m3 push C6 m4 add# C7 m2 rst C9 m1 ret CA m5 jpz CD m5 call  CE m4 adc# D2 m5 jpnc D3 m4 out 41 m3 outbc D6 m4 sub# D9 m1    exx DA m5 jpc DB m4 in 40 m3 inbc 0DE m4 sbc# E2 m5 jppo E3 m1  exsp E6 m4 and# E9 m1 jphl EA m5 jppe EB m1 exde EE m4 xor# F2  m5 jpp F3 m1 di  F6 m4 or# F9 m1 ldsp FA m5 jpm FB m1 ei FE m4  cp# 00 m6 rlc 08 m6 rrc 10 m6 rl 18 m6 rr 20 m6 sla  28 m6 sra  38 m6 srl  40 m7 bit 80 m7 res C0 m7 set B0ED m8 ldir B8ED m8   lddr 44ED m8 neg 57ED m8 ldai 47ED m8 ldia 56ED m8 im1 5EED m8  im2 B1ED m8 cpir 6FED m8 rld -->                                ( z80-asm -- opcodes)                                           : 0outbc  ( -- )  ED c, 71 c,  ;                                : jpix  ( -- )  ix-op c, jphl  ;                                : ldp#  ( 16b rp -- )  8* 1+ c, ,  ;                            : ld#  ( 8b r -- )  8* 06 + c, c,  ;                            : ld  ( r1 r2 -- )  8* 40 + + c,  ;                             : sbcp  ( rp -- )  ED c, 8* 42 + c,  ;                          : adcp  ( rp1 rp2 -- )  ED c, 8* 4A + c,  ;                     : stp  ( a rp -- )  ED c, 8* 43 + c, ,  ;                       : ftp  ( a rp -- )  ED c, 8* 4B + c, ,  ;                       : addix  ( rp -- )  ix-op c, addp  ;                            : addiy  ( rp -- )  iy-op c, addp  ;                            : clr  ( rp -- )  0 swap ldp#  ;                                : ldp  ( rp1 rp2 -- )  2dup ld 1+ swap 1+ swap ld  ;            CF m4 hook       \ rst 0x08                                     D7 m1 prt  -->   \ rst 0x16                                     ( z80-asm -- index register opcodes)                            86 ma addx 8E ma adcx 96 ma subx 9E ma sbcx A6 ma andx          AE ma xorx B6 ma orx  BE ma cpx  34 ma incx 35 ma decx          06 mb rlcx 0E mb rrcx 16 mb rlx  1E mb rrx  26 mb slax          2E mb srax 3E mb srlx 46 mc bitx 86 mc resx C6 mc setx          : ftx   ( disp rpi r -- )   nip 8* 46 + c, c,  ;                : stx   ( r disp rphl -- )  drop swap 70 + c, c,  ;             : st#x  ( 8b disp rpi -- )  drop 36 c, swap c, c,  ;            : ftpx  ( disp rpi rp -- )  3dup 1+ ftx rot 1+ -rot ftx  ;      : stpx  ( disp rpi rp -- )  3dup 1+ stx rot 1+ -rot stx  ;      -->                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- conditional ret and call)                          20 constant z  28 constant nz  30 constant cy  38 constant nc   C2 constant z'  CA constant nz' D2 constant cy' DA constant nc' E2 constant pe' EA constant po' F2 constant m'  FA constant p'  : ?ret  ( op -- )  8 xor 2- c,  ;                               : retc  ( -- )  cy' ?ret ;    : retnc  ( -- )  nc' ?ret  ;      : retz  ( -- )  z' ?ret ;     : retnz  ( -- )  nz' ?ret  ;      : retm  ( -- )  m' ?ret ;     : retp  ( -- )  p' ?ret  ;        : retpe  ( -- )  pe' ?ret ;   : retpo  ( -- )  po' ?ret  ;      : ?call  ( a op -- )  8 xor 2+ c, ,  ;                          : callc  ( -- )  cy' ?call ;    : callnc  ( -- )  nc' ?call  ;  : callz  ( -- )  z' ?call ;     : callnz  ( -- )  nz' ?call  ;  : callm  ( -- )  m' ?call ;     : callp  ( -- )  p' ?call  ;    : callpe  ( -- )  pe' ?call ;   : callpo ( -- )  po' ?call  ;   -->                                                                                                                             ( z80-asm -- control structures with relative jumps)            : >relmark  ( -- orig )  here 1-  ;                             : relresolve  ( orig dest -- )  1- over - ?page swap c!  ;      : >relresolve  ( orig -- )  here relresolve  ;                  : <relresolve  ( dest -- )  here 1- swap relresolve  ;          : ahead  ( -- orig  )  18 , >relmark  ;                         : if  ( op -- orig cs-id )  , >relmark 0A  ;                    : then  ( orig cs-id -- )  0A ?pairs >relresolve  ;             : else  ( orig cs-id -- cs-id ) \ XXX TODO document               0A ?pairs 18 if rot swap then 0A  ;                           : begin  (  -- dest cs-id )  <mark 0B  ;                        : while  (  op -- orig cs-id )  if 2+  ;                        : until  (  dest cs-id op -- )  , 0B ?pairs <relresolve  ;      : again  (  dest cs-id -- )  18 until  ;                        : repeat  (  dest cs-id1 orig cs-id2 )  2swap again 2- then  ;  : step    ( dest cs-id -- )  10 until  ;  -->                   ( z80-asm -- control structures with absolute jumps)            : if'  (  op -- orig cs-id )  c, >mark 08  ;                    : then'  (  orig cs-id -- )  08 ?pairs >resolve  ;              : else'  (  cs-id -- cs-id )                                      08 ?pairs C3 if' rot swap then' 08  ;                         : begin'  (  -- dest cs-id )  <mark 09  ;                       : while'  (  op -- orig cs-id )  if' 2+  ;                      : until'  (  cs-id op -- )  c, 09 ?pairs <resolve  ;            : again'  (  cs-id -- )  C3 until'  ;                           : repeat'  (  dest cs-id1 orig cs-id2 )                           2swap again' 2- then'  ;                                      : |mark  ( -- a )  here 2-  ;                                   : |resolve  ( a -- )  |mark swap !  ;                           -->                                                                                                                                                                                             ( z80-asm -- last opcodes and macros)                           A0 m2 and  B0 m2 or  A8 m2 xor                                  : subp  ( rp -- )  a and sbcp  ;                                : tstp  ( rp -- )  dup a ld 1+ or  ;                            -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- unresolved macro endm )                            6 cells allocate-string                                         : unresolved  ( n -- a )  cells [ dup ] literal +  ;  drop      only forth definitions also assembler                           : macro  ( "name" -- )  : asm  ;                                : endm  ( -- )  end-asm postpone ;  ;  immediate                decimal only forth                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( calc end-calc )                                               need z80-asm                                                    macro calc  ( -- )  exx EF c,  endm                             macro end-calc  ( -- )  38 c, exx  next ix ldp  endm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( << >> )                                                       need @c+  need for                                              : <<  ( -- a depth )  here depth  ;                             : >>  ( a depth -- )                                              depth 1- - #-258 ?throw cr base @ >r hex                        dup 4 u.r space  here over - for  c@+ 3 u.r  step drop          r> base !  space   ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( execute-hl call-xt )                                          macro execute-hl  ( -- )                                          here 6 + bc ldp#  \ point IP to phony_compiled_word             jphl          \ execute the xt in HL                            here cell+ ,      \ point to the phony xt following             endm                                                          macro call-xt  ( xt -- )                                          hl ldp#  execute-hl                                             endm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( bench{ }bench }bench. bench. benched )                        need reset-frames  need frames@                                 : bench{  ( -- )  reset-frames  ;                               : }bench  ( -- d )  frames@ ;                                   : bench.  ( d -- )                                                2dup d. ." frames (" 50 m/ nip . ." s) "  ;                   : }bench.  ( -- )  frames@ bench.  ;                            : benched  ( xt n -- d )                                          bench{ 0 do  dup execute  loop  }bench rot drop  ;            : benched.  ( xt n -- )                                           bench{ 0 do  dup execute  loop  }bench. drop  ;                                                                                                                                                                                                                                                                                                                                               ( all-benchmarks )                                              need byte-magazine-benchmark                                    need interface-age-benchmark                                    need vector-loop-benchmark                                      : all-benchmarks  ( n1 n2 -- )                                    byte-magazine-benchmark                                         interface-age-benchmark                                         vector-loop-benchmark  ;                                        .( To run all benchmarks type:) cr                              .(   n1 n2 all-benchmarks) cr                                                                                                                                                                                                                                                                                                                                                                                                                                 ( ?--> )                                                        : ?-->  ( f -- )  if  postpone -->  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( update flush thru )                                           [unneeded] update                                               ?\ : update  ( -- )  disk-buffer @ $8000 or disk-buffer !  ;    [unneeded] flush                                                ?\ : flush  ( -- )  save-buffers empty-buffers  ;               [unneeded] thru                                                 ?\ : thru  ( block1 block2 -- )  1+ swap ?do  i load  loop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( continued ?load reload loads +load +thru loader )             [unneeded] continued                                            ?\ : continued  ( u -- )  ?loading (load)  ;                    [unneeded] ?load                                                ?\ : ?load  ( block f -- )  if  dup load  then  drop  ;         [unneeded] reload                                               ?\ : reload  ( -- )  empty-buffers  scr @ load  ;               [unneeded] loads                                                ?\ : loads  ( block n -- )  bounds ?do  i load  loop  ;         [unneeded] +load  [unneeded] +thru  and                         ?\ : +load  ( n -- )  blk @ + load  ;                           [unneeded] +thru                                                ?\ : +thru  ( n1 n2 -- )  1+ swap do  i +load  loop  ;          [unneeded] loader ?exit                                         : loader  ( block "name" -- )                                     create ,  does>  ( pfa )  @ load  ;                           ( .line )                                                       : .line  ( n1 n2 -- )  line>string -trailing type  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( [false] [true] )                                                       0 constant [false] immediate                           [false] 0= constant [true]  immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( [if] [else] [then] )                                          need s=                                                         : [else]  ( "..." -- )                                            1 begin   parse-name dup                                          while   2dup s" [if]" s=                                                if    2drop 1+                                                  else  2dup s" [else]" s=                                              if    2drop 1- dup if  1+  then                                 else  s" [then]" s= if  1-  then                                then                                                      then  ?dup 0= if  exit  then                          repeat  2drop drop  ; immediate                               : [if]  ( "..." -- )  0= if postpone [else] then  ; immediate   : [then]  ( -- )  ; immediate                                                                                                                                                                   ( body>name name>body link>name name>link >>link name<name )    [unneeded] body>name                                            ?\ : body>name  ( pfa -- nt ) body> >name  ;                    [unneeded] name>body                                            ?\ : name>body  ( nt -- pfa ) name> >body  ;                    [unneeded] link>name dup  ?\ need alias                         ?\ ' cell+ alias link>name  ( nt -- pfa )                       [unneeded] name>link dup  ?\ need alias                         ?\ ' cell- alias name>link  ( nt -- pfa )                       [unneeded] >>link dup  ?\ need alias                            ?\ ' cell+ alias >>link  ( xtp -- lfa )                         [unneeded] name<name dup  ?\ need name>link                     ?\ : name<name  ( nt1 -- nt2 )  name>link @s  ;                                                                                                                                                                                                                 ( name>interpret name>compile )                                 : name>interpret  ( nt -- xt | 0 )                                ;                                                             : name>compile  ( nt -- x xt )                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( smudge smudged )                                              need c!toggle-bits                                              : smudged  ( nt -- )                                              smudge-mask swap system-bank c!toggle-bits default-bank  ;     : smudge  ( -- )  latest smudged  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( ?pairs )                                                      : ?pairs  ( x1 x2 -- )  <> #-22 ?throw  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( save-here restore-here )                                      variable here-backup                                            : save-here  ( -- )  here here-backup !  ;                      : restore-here  ( -- )  here-backup there  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( case )                                                        0 constant case  immediate compile-only                         : of                                                              postpone over  postpone =  postpone if  postpone drop           ; immediate compile-only                                      : endof  ( orig1 -- orig2 )                                       postpone else  ; immediate compile-only                       : endcase                                                         ( Compilation: 0 orig1..orign -- )                              ( Run-time: x -- )                                              postpone drop  begin  ?dup  while  [compile] then  repeat       ; immediate compile-only                                                                                                                                                                                                                                                                                                      ( case )  \ eforth-case )                                       0 constant case  immediate compile-only                         : of                                                              postpone over postpone = postpone if  postpone drop             ; immediate compile-only                                      : endof  ( orig1 -- orig2 )                                       postpone else  ; immediate compile-only                       : (endcase) ( 0 orig1..orign -- )                                 begin  ?dup  while  [compile] then  repeat  ;                 : endcase                                                         ( Compilation: 0 orig1..orign -- )                              ( Run-time: x -- )                                              postpone drop (endcase)  ; immediate compile-only                                                                                                                                                                                                             ( case )  \ 94-doc-case )                                       0 constant case  immediate compile-only                         : of                                                              1+ >r                                                           postpone over  postpone =   \ copy and test case value          postpone if                 \ add orig to control flow stack    postpone drop               \ discards case value if =          r>  ; immediate compile-only                                  : endof                                                           >r  postpone else  r>  ; immediate compile-only               : endcase                                                         postpone drop  \ discard case value                             0 ?do  postpone then  loop  ; immediate compile-only                                                                                                                                                                                                          ( case )  \ abersoft-case )                                     : case                                                            csp @ !csp  ; immediate compile-only                          : of                                                              postpone over  postpone =  postpone if  postpone drop           ; immediate compile-only                                      : endof                                                           postpone else  ; immediate compile-only                       : endcase                                                         postpone drop                                                   begin  sp@ csp @ <>  while  postpone then  repeat               csp !  ;  immediate                                                                                                                                                                                                                                                                                                           ( between-of )                                                  need between                                                    : (between-of)  ( x1 x2 x3 -- x1 x1 | x1 x1' )                    2>r dup dup 2r> between 0= if  invert  then  ;                : between-of  ( Compilation: -- of-sys )                                      ( Run-time: x1 x2 x3 -- | x1 )                      postpone (between-of) postpone of  ;  immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( less-of )                                                     [defined] nup ?\ : nup  ( x1 x2 -- x1 x1 x2 )  over swap  ;     : (less-of)  ( x1 x2 -- x1 x1 | x1 x1' )                          nup nup >= if  invert  then  ;                                : less-of  ( Compilation: -- of-sys )                                      ( Run-time: x1 x2 -- | x1 )                            postpone (less-of) postpone of  ;  immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( greater-of )                                                  [defined] nup ?\ : nup  ( x1 x2 -- x1 x1 x2 )  over swap  ;     : (greater-of)  ( x1 x2 -- x1 x1 | x1 x1' )                       nup nup <= if  invert  then  ;                                : greater-of  ( Compilation: -- of-sys )                                      ( Run-time: x1 x2 -- | x1 )                         postpone (greater-of) postpone of  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( within-of )                                                   need within                                                     : (within-of)  ( x1 x2 x3 -- x1 x1 | x1 x1' )                     2>r dup dup 2r> within 0= if  invert  then  ;                 : within-of  ( Compilation: -- of-sys )                                      ( Run-time: x1 x2 x3 -- | x1 )                       postpone (within-of) postpone of  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( any-of )                                                      need any?                                                       : (any-of)  ( x0 x1..xn n -- x0 x0 | x0 0 )                       dup 1+ pick >r any? r> tuck and  ;                            : any-of  ( Compilation: -- of-sys )                                      ( Run-time: x0 x1..xn n -- | x0 )                       postpone (any-of) postpone of  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( default-of )                                                  : default-of  ( -- )                                              postpone dup postpone of  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( or-of )                                                       : (or-of)  ( x1 x2 x3 -- x1 x1 | x1 x1' )                         2>r dup dup dup r> = swap r> = or 0= if  invert  then  ;      : or-of  ( Compilation: -- of-sys )                                      ( Run-time: x1 x2 x3 -- | x1 )                           postpone (or-of) postpone of  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( 2nip )  \ ==datastack==                                       code 2nip  ( x1 x2 x3 x4 -- x3 x4 )                               E1 c,            \ pop hl                                       D1 c,            \ pop de                                       F1 c,            \ pop af                                       F1 c,            \ pop af                                       C3 c, pushhlde , \ jp pushhlde                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( roll )                                                        need z80-asm                                                    code roll  ( xu xn .. x0 u -- xn .. x0 xu )                       hl pop  hl addp  hl de ldp  sp addp                             bc push  m c ld  hl incp  m b ld                                bc push  de bc ldp  hl de ldp                                   bc tstp                                                         0000 jpz |mark 0 unresolved !                                   hl decp  hl decp  lddr                                          0 unresolved @ >resolve                                         hl pop  bc pop  exsp                                            jpnext                                                          end-code                                                                                                                                                                                                                                                      ( 3drop 4drop )                                                 code 3drop  ( x1 x2 x3 -- )                                       E1 c,  E1 c,  E1 c,                                             jpnext  end-code                                              code 4drop  ( x1 x2 x3 x4 -- )                                    E1 c,  E1 c,  E1 c,  E1 c,                                      jpnext  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( 3dup )                                                        code 3dup  ( x1 x2 x3 -- x1 x2 x3 x1 x2 x3 )                      D9 c,                                                           C1 c,  D1 c,  E1 c,                                             E5 c,  D5 c,  C5 c,                                             E5 c,  D5 c,  C5 c,                                             D9 c,                                                           jpnext  end-code                                              exit  \ slower and smaller version:                             : 3dup  ( x1 x2 x3 -- x1 x2 x3 x1 x2 x3 )  dup 2over rot  ;                                                                                                                                                                                                                                                                                                                                                                                                     ( 2rot )                                                        need roll                                                       : 2rot  ( x1 x2 x3 x4 x5 x6 -- x3 x4 x5 x6 x1 x2 )                5 roll 5 roll  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( swapped )                                                     : swapped  ( i*x n1 n2 -- j*x )                                   >r 1+ cells sp@ +     ( i*x a1 ) ( R: n2 )                      r> 2+ cells sp@ +     ( i*x a1 a2 )                             over @ over @         ( i*x a1 a2 x1 x2 )                       >r swap !  r> swap !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( nup drup dip )                                                code nup  ( x1 x2 -- x1 x1 x2 )                                   E1 c,  D1 c,  D5 c,  C3 c, pushhlde ,                           end-code                                                      code drup  ( x1 x2 -- x1 x1 )                                     D1 c,  E1 c,  E5 c,  E5 c,  jpnext                              end-code                                                      code dip  ( x1 x2 -- x2 x2 )                                      E1 c, D1 c, E5 c, E5 c,  jpnext                                 end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( 0dup -dup )                                                   code 0dup  ( x -- x | 0 0 )                                       E1 c,  78 04 + c,  B0 05 + c,                                   C2 c, pushhl ,  E5 c,  jppushhl                                 end-code                                                      code -dup  ( x -- x | 0 0 )                                       E1 c,  CB c, 7C c,                                              C2 c, pushhl ,  E5 c,  jppushhl                                 end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ndrop )                                                       need z80-asm                                                    code ndrop  ( x1..xn n -- )                                       hl pop  hl addp  exde  \ DE = n cells                           0 hl ldp#  sp addp  \ HL = stack pointer                        de addp  ldsp  \ update SP                                      jpnext                                                          end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( 2ndrop )                                                      need z80-asm                                                    code 2ndrop  ( dx1..dxn n -- )                                    hl pop  hl addp  hl addp  exde  \ DE = n cells                  0 hl ldp#  sp addp  \ HL = stack pointer                        de addp  ldsp  \ update SP                                      jpnext                                                          end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( buffer: cvariable enum )                                      [unneeded] buffer:                                              ?\ : buffer:  ( u "name" -- )  create allot  ;                  [unneeded] cvariable                                            ?\ : cvariable  ( "name"  -- )  create 1 allot  ;               [unneeded] enum                                                 ?\ : enum  (  n "name" -- n+1 )  dup constant 1+  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( set )                                                         : set  ( x a "name" -- )                                          create  swap , ,                                                does>   ( pfa )  dup @ swap cell+ @ !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( link@ link, )                                                 defer link@  ( node1 -- node2 )                                   ' @ ' link@ defer!                                            : link,  ( node -- )  here over @ , swap !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( ~~ )                                                          need :noname  need defer  need is                               variable ~~?    ~~? on      \ active?                           variable ~~x    ~~x off     \ x coordinate                      variable ~~y    ~~y off     \ y coordinate                      variable ~~key  ~~key off   \ quit key, or zero if no pause     : ~~show  ( nt line block -- )                                    ~~x @ ~~y @ at-xy ." Block " . ." Line " . .name .s   ;       : ~~control  ( -- )                                               ~~key @ ?dup 0= ?exit  key = if  quit  then  ;                2variable ~~backup-xy                                           defer ~~save  ( -- )  defer ~~restore  ( -- )                   :noname  ( -- )  xy ~~backup-xy 2!        ; is ~~save           :noname  ( -- )     ~~backup-xy 2@ at-xy  ; is ~~restore        -->                                                                                                                             ( ~~ )                                                          : (~~)  ( nt line block -- )                                      ~~? @                                                           if    ~~save ~~show ~~control ~~restore                         else  2drop drop  then  ;                                     : ~~  ( -- )                                                      latest      postpone literal                                    >in @ c/l / postpone literal                                    blk @       postpone literal                                    postpone (~~)  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                       ( defers action-of )                                            : defers  ( "name" -- )  ' defer@ compile,  ; immediate         : action-of  ( Interpretation: "name" -- xt )                                ( Compilation:    "name" -- )                                   ( Runtime:        -- xt )                            ' compiling? if    postpone literal postpone defer@                          else  defer@  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( <is> [is] is  )                                               : <is>  ( xt "name" -- )  ' defer!  ;                           : [is]  ( xt "name" -- )                                          postpone ['] postpone defer!  ; immediate compile-only        : is  ( xt "name" -- )                                            compiling? if  postpone [is]  else  <is>  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( deferred? )                                                   : deferred?  ( xt -- wf )  c@ $C3 =  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( abort" )                                                      [defined] abort-message ?\ 2variable abort-message              : (abort")  ( n -- )                                              r> count rot if  abort-message 2! -2 throw  then + >r  ;      : abort"  ( Compilation: "ccc<quote>" -- )                        postpone (abort") ,"  ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( error>ordinal error>line )                                    : error>ordinal  ( -n1 -- +n2 )                                   abs                                                             dup 256 < ?exit                                                 dup 1000 < if  [ 255 091 - ] literal - exit  then               [ 1000 286 - 255 091 - + ] literal -   ;                      : error>line  ( n1 -- n2 )                                        error>ordinal dup >r                                            begin                                                             dup dup 16 / - r@ <>  while  1+                               repeat  rdrop  ;                                                                                                                                                                                                                                                                                                                                                                              \ msg-scr (.throw) \                                            need error>line  need .line                                     variable msg-scr                                                s" Standard error codes" locate msg-scr !                       : (.throw)  ( n -- )                                              msg-scr @                                                       if  error>line msg-scr @ .line space  else  .throw#  then  ;  ' (.throw) ' .throw defer!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ?compiling ?executing )                                       [unneeded] ?compiling                                           ?\ : ?compiling  ( -- )  compiling? 0= -14 ?throw  ;            [unneeded] ?executing                                           ?\ : ?executing  ( -- )  compiling? -263 ?throw  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( rdraw )                                                       need z80-asm                                                    code rdraw  ( xc yc -- )                                          hl pop  de pop  bc push                                         de bc ldp                                                       1 e ld#                                                         b 7 bit  \ negative x?                                          nz if  c a ld  neg  -1 e ld#  a c ld  then  \ negative x        l b ld   \ y                                                    1 d ld#                                                         h 7 bit  \ negative y?                                          nz if  b a ld  neg  -1 d ld#  a b ld  then  \ negative y        24BA call \ alternative entry to the DRAW-LINE ROM routine      bc pop                                                          jpnext end-code                                                                                                               \ (rdraw) \                                                     need z80-asm                                                    create (rdraw)                                                  asm                                                             end-asm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( adraw ) \ from Abersoft Forth                                 need plot                                                       2variable x1  2variable incx  2variable y1  2variable incy      : adraw  ( xc yc -- )                                             23678 c@ ( y0 ) dup 0 swap y1 2! - dup abs rot                  23677 c@ ( x0 ) dup 0 swap x1 2! - dup abs rot                  max >r dup 0<  \ negative xdiff?                                if    abs 0 swap r@ ud/mod dnegate                              else  0 swap r@ ud/mod  then                                    incx 2! drop dup 0<  \ negative ydiff?                          if    abs 0 swap r@ ud/mod dnegate                              else  0 swap r@ ud/mod  then                                    incy 2! drop r> 1+ 0                                            do  x1 @ y1 @ plot                                                  x1 2@ incx 2@ d+ x1 2!                                          y1 2@ incy 2@ d+ y1 2!  loop  ;                           ( ocr )                                                         need z80-asm  need ocr-chars                                    code ocr  ( col line -- n )                                       de pop  hl pop  bc push                                         l b ld  e c ld  ocr-charset fthl                                c a ld  rrca  rrca  rrca  E0 and#  b xor  a e ld                c a ld  18 and#  40 xor#  a d ld                                0 de stp |mark 0 unresolved !                                   ocr-chars fta  a b ld                                           begin                                                             bc push  hl push                                                0 de ldp#  \ restore the screen address                         |mark 0 unresolved @ !                                      -->                                                                                                                                                                                             ( ocr )                                                             08 b ld# \ scans                                                begin                                                             de ftap  m xor  \ scan match?                                   here jrnz >relmark 1 unresolved !                               d inc  hl incp  \ update the pointers                         step  \ next scan                                               bc pop  bc pop                                                  ocr-chars fta  b sub  a b ld                                    ocr-first fta  b add  a b ld                                    here jr >relmark 2 unresolved !                                 1 unresolved @ >relresolve                                      hl pop  0008 de ldp#  de addp  bc pop                         step                                                            2 unresolved @ >relresolve  0 h ld#  b l ld                     bc pop  jppushhl  end-code                                    ( ocr-charset ocr-first ocr-chars ascii-ocr udg-ocr )           variable ocr-charset                                            variable ocr-first                                              variable ocr-chars                                              need os-chars  need os-udg                                      : ascii-ocr  ( -- )                                               os-chars @ 256 + ocr-charset !                                  32 ocr-first !                                                  95 ocr-chars !  ;                                             : udg-ocr  ( n -- )                                               os-udg @ ocr-charset !                                          128 ocr-first !                                                 ocr-chars !  ;                                                19 udg-ocr  \ default                                                                                                                                                                           ( pixel-addr )                                                  need (pixel-addr)                                               code pixel-addr  ( xc yc -- n a )                                 E1 c,  D1 c,            \ pop hl / pop de                       C5 c,                   \ push bc                               40 05 + c,              \ ld b,l ; b=y                          48 03 + c,              \ ld c,e ; c=x                          CD c, (pixel-addr) ,       \ call (pixel-addr)                  C1 c,                   \ pop bc                                16 c, 0 c,  58 07 + c,  \ ld d,0 / ld e,a                       C3 c, pushhlde ,        \ jp pushhlde                           end-code                                                                                                                                                                                                                                                                                                                      \ (pixel-addr) \                                                create (pixel-addr)  ( -- a )                                     asm                                                             3E c, BF c,   \ ld a,191 ; max Y coordinate                     90 00 + c,    \ sub b                                           C3 c, 22B0 ,  \ jp 0x22B0 ; and return                          end-asm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ (pixel-addr) \                                                need z80-asm                                                    create (pixel-addr)  ( -- a )                                     asm                                                             BF a ld#  b sub                                                 a b ld  rra  scf  rra  a and  rra                               b xor  F8 and#  b xor  a h ld                                   c a ld                                                          rlca rlca rlca  b xor  C7 and#                                  b xor  rlca  rlca                                               a l ld                                                          c a ld  07 and#                                                 ret                                                             end-asm                                                                                                                                                                                       ( plot )                                                        need (pixel-addr)                                               code plot  ( xc yc -- )                                           D9 c,               \ exx ; save Forth IP                       E1 c,               \ pop hl                                    C1 c,               \ pop bc                                    40 05 + c,          \ ld b,l                                    ED c, 43 c, 5C7D ,  \ ld (0x5C7D),bc ; update COORDS            CD c, (pixel-addr) ,   \ call (pixel-addr)                      CD c, 22EC ,        \ call 0x22EB ; ROM PLOT-SUB + 7            D9 c,               \ exx ; restore Forth IP                    DD c, 21 c, next ,  \ ld ix,next ; restore ix                   jpnext              \ jp (ix)                                   end-code                                                                                                                                                                                      ( set-pixel )                                                   need (pixel-addr)  need z80-asm                                 code set-pixel  ( xc yc -- )                                      hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               m or  a m ld  \ combine pixel with byte in the screen           bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( reset-pixel )                                                 need (pixel-addr)  need z80-asm                                 code reset-pixel  ( xc yc -- )                                    hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               cpl  m and  a m ld  \ combine pixel with byte in the screen     bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( toggle-pixel )                                                need (pixel-addr)  need z80-asm                                 code toggle-pixel  ( xc yc -- )                                   hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               m xor  a m ld  \ combine pixel with byte in the screen          bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( test-pixel )                                                  need (pixel-addr)  need z80-asm                                 code test-pixel  ( xc yc -- f )                                   hl pop  de pop  bc push                                         l b ld  e c ld                                                  (pixel-addr) call                                               a b ld  b inc  m a ld                                           begin  rlca  step \ rotate to bit 0                             bc pop  \ restore the Forth IP                                  1 and#  \ pixel?                                                ' true jpnz                                                     ' false jp                                                      end-code                                                                                                                                                                                                                                                      ( pixels )                                                      need z80-asm                                                    code pixels  ( -- u )                                             exx                                                             4000 hl ldp#  l b ld  l c ld                                    begin  \ byte                                                     08 d ld#                                                        begin  \ bit                                                      m rrc  cy if  bc incp  then  d dec                            z until                                                         hl incp  h a ld  58 cp#                                       z until                                                         bc push                                                         exx                                                             jpnext                                                          end-code                                                      ( at-accept clear-accept set-accept )                           2variable accept-xy       \ coordinates of the edited string    variable accept-buffer    \ address of the edited string        variable /accept          \ max length of the edited string     variable >accept          \ offset to the cursor position       : at-accept  ( -- )  accept-xy 2@ at-xy  ;                      : clear-accept  ( -- )                                            at-accept span @ spaces at-accept  span off  ;                : set-accept  ( ca1 len1 -- ca1' )                                clear-accept /accept @ min  ( ca1 len1' )                       dup span ! 2dup system-bank type default-bank                   dup >r                                                          accept-buffer @  ( ca1 len1' ca2 )                              smove accept-buffer @  ( ca2 )                                  r> +  ( ca1' )  ;                                                                                                             ( acceptx )                                                     need at-accept  need set-accept                                 : .acceptx  ( -- )                                                accept-buffer @ >accept @ at-accept type                        1 inverse  >accept @ span @ <                                   if accept-buffer @ >accept @ + c@ emit  else  space  then       0 inverse                                                       accept-buffer @ span @ >accept @ 1+ min /string type            ;                                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( acceptx )                                                     need toggle-capslock                                            : accept-edit  ( -- )  clear-accept init-accept  ;              : accept-left  ( -- )  ;                                        : accept-right  ( -- )  ;                                       : accept-up  ( -- )  ;                                          : accept-down  ( -- )  ;                                        : accept-delete  ( -- )  ;                                      create accept-commands ] noop noop noop noop noop noop          toogle-capslock accept-edit accept-left accept-right            accept-down accept-up accept-delete noop noop noop noop noop    noop noop noop noop noop noop noop noop noop noop noop noop [   : >accept-command  ( c -- a )  cells accept-commands +  ;       : accept-command  ( c -- )  >accept-command perform  ;          -->                                                                                                                             ( acceptx )                                                     : init-acceptx  ( ca len -- )                                     /accept !  accept-buffer !  >accept off  xy accept-xy 2!  ;   : (acceptx) ( ca len -- len' )  2dup init-accept                  over + over ( bot eot cur )                                     begin  key dup 13 <> \ not carriage return?                     while                                                             dup 12 =  \ delete?                                             if    drop  >r over r@ < dup  \ any chars?                            if  8 dup emit  bl emit  emit  then  r> +                 else  \ printable                                                     >r  2dup <>  \ more?                                            if r@ over c!  char+  r@ emit                                   then r> drop                                              then                                                          repeat  drop nip swap -  ;  -->                               ( acceptx )                                                     : acceptx ( ca len -- len' )                                      span off  ?dup 0= if  drop 0  else  (acceptx)  then  ;        : ax  ( -- )  ['] acceptx ['] accept defer!  ;                  : a0  ( -- )  ['] default-accept ['] accept defer!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( nuf? )                                                        need aborted?                                                   [defined] 'cr' ?\ 13 constant 'cr' \ code of carriage return    : nuf?  ( -- f )  'cr' aborted?  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( aborted? )                                                    : aborted?  ( c -- f )                                            key? dup  if    key 2drop key =                                           else  nip  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( break? )                                                      : break?  ( -- f )                                                key? dup if  key 2drop break-key?  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( Keyboard rows ports)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( kk-ports kk, kk@ )                                            /kk 3 <> dup                                                    ?\ : kk,  ( bitmask port -- ) , c,  ;                           ?\ : kk@  ( a -- bitmask port ) dup c@ swap 1+ @ ;              /kk 4 <> dup                                                    ?\ : kk,  ( d -- )  2,  ;                                       ?\ : kk@  ( a -- bitmask port )  2@  ;                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( kk-ports )                                                    $01 $F7FE 2constant kk-1  $02 $F7FE 2constant kk-2              $04 $F7FE 2constant kk-3  $08 $F7FE 2constant kk-4              $10 $F7FE 2constant kk-5                                        $01 $FBFE 2constant kk-q  $02 $FBFE 2constant kk-w              $04 $FBFE 2constant kk-e  $08 $FBFE 2constant kk-r              $10 $FBFE 2constant kk-t                                        $01 $FDFE 2constant kk-a  $02 $FDFE 2constant kk-s              $04 $FDFE 2constant kk-d  $08 $FDFE 2constant kk-f              $10 $FDFE 2constant kk-g                                        $01 $FDFE 2constant kk-cs  $02 $FDFE 2constant kk-z             $04 $FDFE 2constant kk-x   $08 $FDFE 2constant kk-c             $10 $FDFE 2constant kk-v                                        -->                                                                                                                                                                                             ( kk-ports )                                                    $01 $EFFE 2constant kk-0  $02 $EFFE 2constant kk-9              $04 $EFFE 2constant kk-8  $08 $EFFE 2constant kk-7              $10 $EFFE 2constant kk-6                                        $01 $DFFE 2constant kk-p  $02 $DFFE 2constant kk-o              $04 $DFFE 2constant kk-i  $08 $DFFE 2constant kk-u              $10 $DFFE 2constant kk-y                                        $01 $BFFE 2constant kk-en  $02 $BFFE 2constant kk-l             $04 $BFFE 2constant kk-k   $08 $BFFE 2constant kk-j             $10 $BFFE 2constant kk-h                                        $01 $7FFE 2constant kk-sp $02 $7FFE 2constant kk-ss             $04 $7FFE 2constant kk-m  $08 $7FFE 2constant kk-n              $10 $7FFE 2constant kk-b                                        -->                                                                                                                                                                                             ( kk-ports )                                                    need kk,                                                        40 constant keys                                                create kk-ports                                                 kk-1  kk,  kk-2  kk,  kk-3 kk,  kk-4 kk,  kk-5 kk,              kk-q  kk,  kk-w  kk,  kk-e kk,  kk-r kk,  kk-t kk,              kk-a  kk,  kk-s  kk,  kk-d kk,  kk-f kk,  kk-g kk,              kk-cs kk,  kk-z  kk,  kk-x kk,  kk-c kk,  kk-v kk,              kk-0  kk,  kk-9  kk,  kk-8 kk,  kk-7 kk,  kk-6 kk,              kk-p  kk,  kk-o  kk,  kk-i kk,  kk-u kk,  kk-y kk,              kk-en kk,  kk-l  kk,  kk-k kk,  kk-j kk,  kk-h kk,              kk-sp kk,  kk-ss kk,  kk-m kk,  kk-n kk,  kk-b kk,                                                                                                                                                                                                                                                                              ( kk-1# )                                                       need enum                                                       0                                                               enum kk-1#  enum kk-2#  enum kk-3# enum kk-4# enum kk-5#        enum kk-q#  enum kk-w#  enum kk-e# enum kk-r# enum kk-t#        enum kk-a#  enum kk-s#  enum kk-d# enum kk-f# enum kk-g#        enum kk-cs# enum kk-z#  enum kk-x# enum kk-c# enum kk-v#        enum kk-0#  enum kk-9#  enum kk-8# enum kk-7# enum kk-6#        enum kk-p#  enum kk-o#  enum kk-i# enum kk-u# enum kk-y#        enum kk-en# enum kk-l#  enum kk-k# enum kk-j# enum kk-h#        enum kk-sp# enum kk-ss# enum kk-m# enum kk-n# enum kk-b#        drop                                                                                                                                                                                                                                                                                                                            ( kk-chars )                                                    create kk-chars                                                 char 1 c,  char 2 c,  char 3 c,  char 4 c,  char 5 c,           char q c,  char w c,  char e c,  char r c,  char t c,           char a c,  char s c,  char d c,  char f c,  char g c,           128    c,  char z c,  char x c,  char c c,  char v c,           char 0 c,  char 9 c,  char 8 c,  char 7 c,  char 6 c,           char p c,  char o c,  char i c,  char u c,  char y c,           129    c,  char l c,  char k c,  char j c,  char h c,           130    c,  131    c,  char m c,  char n c,  char b c,                                                                                                                                                                                                                                                                                                                                                                                                           ( pressed pressed? )                                            need [if]                                                       [needed] pressed? [needed] pressed or [if]                      need @p                                                         : pressed? ( n1 n2 -- f )  @p and 0=  ;                         [then]                                                          [needed] pressed [if]                                           need pressed?  need kk-ports                                    : pressed  ( -- false | n1 n2 true )                              0 \ false by default                                            [ kk-ports keys /kk * bounds swap ] literal literal             do  i kk@ pressed? if  drop i kk@ 1 leave  then  /kk +loop  ; [then]                                                                                                                                                                                                                                                          ( only-one-pressed )                                            need kk-ports                                                   0. 2variable kk-pressed                                         : only-one-pressed  ( -- false | n1 n2 true )                     0. kk-pressed 2! \ none by default                              [ kk-ports keys /kk * bounds swap ] literal literal             do  i kk@ pressed?                                              if  kk-pressed 2@ + if                                          then                                                            /kk +loop                                                       kk-pressed 2@ 2dup + if  1  else  2drop 0  then  ;                                                                                                                                                                                                                                                                                                                                            ( inkey )                                                       need z80-asm                                                    code inkey  ( -- c | 0 )                                          a xor                                                           01 iy 5 bitx  \ a new key pressed?                              nz if                                                             5C08 hl ldp#  \ LAST-K system variable                          m a ld                                                          01 iy 5 resx                                                  then                                                            pusha jp                                                        end-code                                                                                                                                                                                                                                                                                                                      ( under+ )  \ ==operators==                                     code under+  ( n1|u1 x n2|u2 -- n3|u3 x )                         D9 c,           \ exx                                           D1 c,           \ pop de                                        C1 c,           \ pop bc                                        E1 c,           \ pop hl                                        19 c,           \ add hl,de                                     E5 c,           \ push hl                                       C5 c,           \ push bc                                       D9 c,           \ exx                                           jpnext  end-code                                                                                                                                                                                                                                                                                                                                                                              ( +under )                                                      code +under  ( n1|u1 n2|u2 x -- n3|u3 x )                         D9 c,           \ exx                                           C1 c,           \ pop bc                                        D1 c,           \ pop de                                        E1 c,           \ pop hl                                        19 c,           \ add hl,de                                     E5 c,           \ push hl                                       C5 c,           \ push bc                                       D9 c,           \ exx                                           jpnext  end-code                                                                                                                                                                                                                                                                                                                                                                              ( within between )                                              [unneeded] within                                               ?\ : within  ( n1|u1 n2|u2 n3|u3 -- f )  over - >r - r> u<  ;   [unneeded] between ?exit                                        : between  ( n1|u1 n2|u2 n3|u3 -- f )  over - -rot - u< 0=  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( polarity )                                                    code polarity  ( n -- -1 | 0 | 1 )                                D1 c, 78 02 + c,  B0 03 + c,  CA c, ' false ,                   CB c, 10 03 + c,  ED c, 62 c,                                   78 05 + c,  F6 c, 01 c,  68 07 + c,  jppushhl                   end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( u<= u>= <= >= 0>= 0<= )                                       [unneeded] u<=  ?\ : u<=  ( u1 u2 -- f )  u> 0=  ;  exit        [unneeded] u>=  ?\ : u>=  ( u1 u2 -- f )  u< 0=  ;  exit        [unneeded] <=   ?\ : <=   ( n1 n2 -- f )  > 0=   ;  exit        [unneeded] >=   ?\ : >=   ( n1 n2 -- f )  < 0=   ;  exit        [unneeded] 0>=  ?\ : 0>=  ( n1 n2 -- f )  0< 0=  ;  exit        [unneeded] 0<=  ?\ : 0<=  ( n1 n2 -- f )  0> 0=  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( lshift )                                                      need z80-asm                                                    code lshift  ( x1 u -- x2 )                                       exx                                                             bc pop  \ C = loop counter                                      c b ld                                                          hl pop  \ hi 8 bits ignored!                                    b inc  ahead 0 unresolved !                                     begin  hl addp  0 unresolved @ >relresolve  step                hl push                                                         exx                                                             jpnext                                                          end-code                                                                                                                                                                                                                                                      ( lshift )                                                      code lshift  ( x1 u -- x2 )                                       D1 c,           \ pop de                                        E1 c,           \ pop hl                                        1C c,           \ inc e                                         here            \ begin:                                        1D c,           \ dec e                                         CA c, pushhl ,  \ jp z,push_hl                                  29 c,           \ add hl,hl                                     C3 c, ,         \ jp begin                                      end-code                                                                                                                                                                                                                                                                                                                                                                                      ( rshift )                                                      need z80-asm                                                    code rshift  ( x1 u -- x2 )                                       exx                                                             bc pop  \ C = loop counter                                      c b ld                                                          hl pop  \ hi 8 bits ignored!                                    b inc  ahead 0 unresolved !                                     begin  h srl  l rr  0 unresolved @ >relresolve  step            hl push                                                         exx                                                             jpnext                                                          end-code                                                                                                                                                                                                                                                      ( rshift )                                                      code rshift  ( x1 u -- x2 )                                       D1 c,           \ pop de                                        E1 c,           \ pop hl                                        1C c,           \ inc e                                         here            \ begin:                                        1D c,           \ dec e                                         CA c, pushhl ,  \ jp z,push_hl                                  CB c, 3C c,     \ srl h                                         CB c, 1D c,     \ rr l                                          C3 c, ,         \ jp begin                                      end-code                                                                                                                                                                                                                                                                                                                      ( 2/ )                                                          code 2/  ( x1 -- x2 )                                             E1 c,           \ pop hl                                        CB c, 2C c,     \ sra h                                         CB c, 1D c,     \ rr l                                          jppushhl        \ jp pushhl                                     end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( sqrt )                                                        need d2*  need 2/                                               [defined] cell-bits ?\ 16 constant cell-bits                    : (sqrt)  ( radicand -- remainder root )                          0 0                           ( radicand remainder root )       [ cell-bits 2/ ] literal 0 do                                     >r d2* d2* r>               \ shift remainder left 2 bits       2*                          \ shift root left 1 bit             2dup 2* u> if               \ check for next bit of root          >r r@ 2* - 1- r>          \ reduce remainder                    1+                        \ add a bit to root                 then                                                          loop  cr .s rot drop  ;                                       : sqrt  ( radicand -- root )  (sqrt) nip  ;                                                                                                                                                     ( sqrt )                                                        : sqrt  ( n1 -- n2 )                                              dup 0< -24 ?throw  \ invalid numeric argument                   dup                                                             if  dup 2/  20 0                                                    do      2dup / + 2/                                             loop    swap drop                                           then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( sm/rem )                                                      : sm/rem  ( d1 n1 -- n2 n3 )                                      2dup xor >r  \  sign of quotient                                over >r      \  sign of remainder                               abs >r dabs r> um/mod                                           swap r> ?negate                                                 swap r> ?negate  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( /-rem /- -rem */-rem */- )                                    : /-rem  ( n1 n2 -- n3 n4 )  >r  s>d  r> sm/rem  ;              : /-  (  n1 n2 -- n3 )  /-rem nip  ;                            : -rem  ( n1 n2 -- n3 )  /-rem drop  ;                          : */-rem  (  n1 n2 n3 -- n4 n5 )  >r  m*  r> sm/rem  ;          : */-  ( n1 n2 n3 -- n4 )  */-rem nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fm/mod )                                                      : fm/mod  ( d1 n1 -- n2 n3 )                                      dup >r                \ save divisor                            sm/rem                                                          over 0<> over 0< and  \ quotient<0 and remainder<>0?            if                                                                swap r> +           \ add divisor to remainder                  swap 1-             \ decrement quotient                      else r> drop then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( /_mod /_ _mod */_mod */_ )                                    need fm/mod                                                     : /_mod  ( n1 n2 -- n3 n4 )  >r s>d r> fm/mod  ;                : /_  ( n1 n2 -- n3 )  /_mod nip  ;                             : _mod  ( n1 n2 -- n3 )  /_mod drop  ;                          : */_mod  ( n1 n2 n3 -- n4 n5 )  >r m* r> fm/mod  ;             : */_  ( n1 n2 n3 -- n4 )   */_mod nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( any? )                                                        need roll                                                       variable (any?)                                                 : any?  ( x0 x1..xn n -- f )                                      dup 1+ roll (any?) !                                            0 swap 0 do  swap (any?) @ = or  loop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( % u% )                                                        : %  ( n1 n2 -- n3 )  100 swap */  ;                            : u%  ( u1 u2 -- u3 )  >r 100 um* r> um/mod nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( parse-line )                                                  : parse-line  ( "ccc<eol>" -- ca len )                            source span @ min c/l min  >in @ span @ min /string             dup >in +! save-string  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( evaluate )                                                    : execute-parsing  ( ca len xt -- )                               >in @ >r >in off                                                source >r >r ;                                                : evaluate  ( ca len -- )  ['] interpret execute-parsing  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( parse-char )                                                  : parse-char  ( "c"  -- c )  stream drop c@ 1 parsed  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( word )                                                        : word  ( c "<chars>ccc<char>" -- ca )                            dup  stream                 ( c c ca len )                      dup >r   rot skip           ( c ca' len' )                      over >r  rot scan           ( ca" len" )                        dup if  char-  then         \ skip trailing delimiter           r> r> rot -   >in +!        \ update `>in`                      tuck -                      ( ca' len )                         here place  here            ( ca )                              bl over count + c!  ;       \ append trailing blank                                                                                                                                                                                                                                                                                                                                                                                                           ( defined? )                                                    : defined?  ( ca len -- wf )  undefined? 0=  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( save-input restore-input )                                    : save-input ( -- xn ... x1 n )                                   source-id 0>                                                    if tib #tib @ 2dup c/l 2 + allocate throw dup >r swap cmove        r> to tib  >in @                                                source-id file-position throw                                   5                                                            else blk @ >in @ 2 then                                         ;                                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( save-input restore-input )                                    : restore-input ( xn ... x1 n -- f )                              source-id 0>                                                    if dup 5 <> if 0 ?do drop loop -1 exit then                        drop source-id reposition-file ?dup                             if >r 2drop drop r> exit then                                   >in ! #tib ! to tib false                                    else dup 2 <> if 0 ?do drop loop -1 exit then                      drop >in ! blk ! false                                       then                                                            ;                                                                                                                                                                                                                                                                                                                                                                                             ( @p )                                                          code @p  ( a -- b )                                               E1 c,           \ pop hl                                        C5 c,           \ push bc                                       48 05 + c,      \ ld c,l                                        40 04 + c,      \ ld b,h                                        ED c, 68 c,     \ in l,(c)                                      C1 c,           \ pop bc                                        26 c, 00 c,     \ ld h,0x00                                     jppushhl        \ jp pushhl                                     end-code                                                                                                                                                                                                                                                                                                                                                                                      ( !p )                                                          code !p  ( b a -- )                                               E1 c,           \ pop hl                                        D1 c,           \ pop de ; char in e                            C5 c,           \ push bc                                       48 05 + c,      \ ld c,l                                        40 04 + c,      \ ld b,h                                        ED c, 59 c,     \ out (c),e                                     C1 c,           \ pop bc                                        jpnext          \ jp (ix)                                       end-code                                                                                                                                                                                                                                                                                                                                                                                      ( tabulate tab-stop )                                           need column                                                     variable tab-stop  8 tab-stop !                                 : tabulate  ( -- )  column 1+ tab-stop @ tuck mod - spaces  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( 'cr' 'tab' 'bs' crs tab tabs backspace backspaces )            6 constant 'tab'                                                8 constant 'bs'                                                13 constant 'cr'                                                : tab          ( -- )  'tab' emit  ;                            : backspace    ( -- )  'bs'  emit  ;                            : crs           ( n -- )  'cr'  emits  ;                        : tabs          ( n -- )  'tab' emits  ;                        : backspaces    ( n -- )  'bs'  emits  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( column last-column row last-row at-x at-y )                   : column  ( -- col )  xy drop  ;                                : last-column  ( -- row  )  column 1-  ;                        : row  ( -- row )  xy nip  ;                                    : last-row  ( -- row  )  row 1-  ;                              : at-x  ( col -- )  row at-xy  ;                                : at-y  ( row -- )  column swap at-xy  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( randomize randomize0 )                                        need os-seed                                                    [needed] randomize0 ?\ : randomize  ( n -- )  os-seed !  ;      need os-frames                                                  : randomize0  ( n -- )                                            ?dup 0=  if  os-frames @  then  os-seed !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( rnd random )  \ ==rng==                                       need os-seed                                                    : rnd  ( -- n )  os-seed @ 31421 * 6927 + dup os-seed !  ;      : random  ( n -- 0..n-1 )  rnd um* nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( random-range )                                                need random                                                     : random-range ( n1 n2 -- n3 ) over - 1+ random +  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( rng-benchmark )                                               need set-pixel  need bench{  need pixels  need u%  need 3dup    256 192 * constant #pixels                                      defer rng  ( n -- 0..n-1 )                                      : pixels%.  ( u -- )  #pixels u% 0.r ." %"  ;                   : .pixels  ( u -- )  dup u. ." pixels (" pixels%. ." )"  ;      : .title  ( ca len -- )  ." Code: " type  ;                     variable cycles                                                 defer .cycles  ( -- )                                           : (.cycles)  ( -- )                                               cycles ?  s" cycles" cycles @ 1 = + type  ;                   : .time  ( d -- )  bench. ." per cycle" cr  ;                   : .result  ( ca len d -- )                                        2>r pixels >r  .title cr  r> .pixels cr                         2r> .time .cycles   ;                                         -->                                                             ( rng-benchmark )                                               defer random-coords  ( -- xc yc )                               : (random-coords)  ( -- xc yc )  256 rng 193 rng  ;             : fill-screen  ( -- )                                             #pixels 0 do  random-coords set-pixel  loop  ;                : signal  ( -- )  cycles @ %111 and border  ;                   : (rng-benchmark)  ( -- d )                                       1 cycles +!  signal  bench{ fill-screen }bench  ;             : wait  ( -- )  key drop  ;                                     : finish  ( ca len d -- )  0 border  .result  wait  ;           : init  ( xt1 xt2 x3 -- )                                         ['] random-coords defer!  ['] .cycles defer!  ['] rng defer!    page  -1 cycles !  ;                                          defer finish?  ( i*x -- j*x f )                                 : new-pixels?  ( n1 -- n2 f )  pixels tuck =  ;                 ' new-pixels? ' finish? defer!  -->                             ( rng-benchmark )                                               defer rng-benchmark  ( ca len xt -- )                           : (rng-benchmark2)  ( ca len -- )                                 0 begin   (rng-benchmark) 2>r                                             finish? dup 0= if  2rdrop  then                       until     drop 2r> finish  ;                                  : rng-benchmark2  ( ca len xt -- )                                ['] (.cycles) ['] (random-coords) init  (rng-benchmark2)  ;   ' rng-benchmark2 ' rng-benchmark defer!  \ default benchmark    : (.cycle)  ( -- )  ." First cycle only"  ;                     : (rng-benchmark1)  ( ca len -- )                                 (rng-benchmark) .result wait  ;                               : rng-benchmark1  ( ca len xt -- )                                ['] (.cycle) ['] (random-coords) init  (rng-benchmark1)  ;    -->                                                                                                                             ( rng-benchmark )                                               : crnd-coords  ( -- xc yc )  rng rng 192 min  ;                 : rng8-benchmark2  ( ca len xt -- )                               ['] (.cycles) ['] crnd-coords init  (rng-benchmark2)  ;       : rng8-benchmark1  ( ca len xt -- )                               ['] (.cycle) ['] crnd-coords init  (rng-benchmark1)  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( all-rng-benchmarks )                                          need rng-benchmark  need +thru  1 13 +thru                      ace-rng-benchmark   dx-rng-benchmark                            gf-rng-benchmark    jer-rng-benchmark                           jml-rng-benchmark   lb-rng-benchmark                            lina-rng-benchmark  mb-rng-benchmark                            sf83-rng-benchmark  tt-rng-benchmark                            vf-rng-benchmark    z88-rng-benchmark                           zh-rng-benchmark                                                ' rng-benchmark1 ' rng-benchmark defer!                         dx-rng-benchmark  vf-rng-benchmark                                                                                                                                                                                                                                                                                                                                                              ( ace-random )                                                  need os-seed                                                    : ace-rnd  ( -- n )                                               os-seed @ 75 um* 75. d+ 2dup u< - - 1- dup os-seed !  ;       : ace-random  ( n1 -- n2 )  ace-rnd um* nip  ;                  need rng-benchmark                                              : ace-rng-benchmark  ( -- )                                       s" Jupiter ACE manual" ['] ace-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( dx-random )                                                   2variable dx-seed  1. dx-seed 2!                                need d*                                                         : dx-rnd ( -- u )                                                 dx-seed 2@ $15A4E35. d* 1. d+ tuck dx-seed 2!  ;              : dx-random ( u -- 0..u-1 )  dx-rnd um* nip  ;                  need rng-benchmark                                              : dx-rng-benchmark  ( -- )                                        s" DX-Forth" ['] dx-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( gf-random )                                                   need os-seed  need ud*                                          : gf-rnd  ( -- n )                                                272958469. os-seed @ ud* d>s 1+ dup os-seed !  ;              : gf-random  ( n1 -- n2 )  gf-rnd um* nip  ;                    need rng-benchmark                                              : gf-rng-benchmark  ( -- )                                        s" Gforth" ['] gf-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( jer-random )                                                  need os-seed                                                    : jer-rnd  ( -- n )                                               os-seed @ 259 * 3 + 32767 and dup os-seed !  ;                : jer-random ( n1 -- n2 )                                         jer-rnd 32767 */  ;                                           need rng-benchmark                                              : jer-rng-benchmark  ( -- )                                       s" J. E. Rickenbacker" ['] jer-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( jml-random )                                                  need z80-asm  need os-seed                                      code jml-rnd  ( -- u )                                            os-seed fthl  hl push                                           hl addp  hl addp  hl addp  hl addp  hl addp  hl addp            de pop  de addp  0029 de ldp#  de addp                          os-seed sthl                                                    jppushhl                                                        end-code                                                      : jml-random  ( n -- 0..n-1 )  jml-rnd um* nip  ;               need rng-benchmark                                              : jml-rng-benchmark  ( -- )                                       s" J.M. Lazo" ['] jml-random rng-benchmark  ;                                                                                                                                                                                                                 ( lb-random )                                                   need os-seed                                                    : lb-rnd  ( -- n )  os-seed @ 31421 * 6927 + dup os-seed !  ;   : lb-random  ( n -- 0..n-1 )  lb-rnd um* nip  ;                 need rng-benchmark                                              : lb-rng-benchmark  ( -- )                                        s" Leo Brodie" ['] lb-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( lina-random )                                                 need os-seed                                                    : lina-rnd  ( -- n )                                              os-seed @ 107465 * 234567 + dup os-seed !  ;                  : lina-random  ( n1 -- n2 )  lina-rnd um* nip ;                 need rng-benchmark                                              : lina-rng-benchmark  ( -- )                                      s" lina" ['] lina-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( mb-random )                                                   need z80-asm  need os-seed                                      code mb-rnd  ( -- n )                                             os-seed de ftp                                                  d a ld  e h ld  #253 l ld#                                      a or  de sbcp                                                   0 sbc#  de sbcp                                                 0 d ld#  d sbc  a e ld                                          de sbcp                                                         cy if  hl incp  then                                            os-seed sthl                                                    jppushhl   end-code                                           : mb-random  ( n1 -- n2 )  mb-rnd um* nip  ;                    need rng-benchmark                                              : mb-rng-benchmark  ( -- )                                        s" Milos Bazelides" ['] mb-random rng-benchmark  ;            ( sf83-random )                                                 need os-seed  3 os-seed !                                       : sf83-random  ( n -- 0..n-1 )                                    os-seed @ 743 * 43 + dup os-seed ! um* swap drop  ;           need rng-benchmark                                              : sf83-rng-benchmark  ( -- )                                      s" Spectrum Forth-83" ['] sf83-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( tt-random )                                                   need os-seed                                                    : tt-random   ( n -- 0..n-1 )                                       os-seed @ 13 * $7FFF and                                        dup os-seed !  swap mod ;                                   need rng-benchmark                                              : tt-rng-benchmark  ( -- )                                        s" Tetris for terminals" ['] tt-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( vf-random )                                                   need os-frames                                                  : vf-random  ( n1 -- n2 )                                         1+ 8195 os-frames @ um* 1. d+                                   16383 um/mod drop                                               swap mod  ;                                                   need rng-benchmark                                              : vf-rng-benchmark  ( -- )                                        s" vForth" ['] vf-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( z88-random )                                                  need ud*  need os-seed                                          : z88-random  ( u1 -- u2 )                                        1103515245. \ 20077 16838                                       os-seed @ ud* 12345. d+ over os-seed !                          rot ud/mod 2drop  ;                                           need rng-benchmark                                              : z88-rng-benchmark  ( -- )                                       s" Z88 CamelForth" ['] z88-random rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( zh-random )                                                   need z80-asm  need os-seed                                      code zh-rnd  ( -- n )                                             os-seed fthl                                                    hl de ldp                                                       hl addp  de addp  hl addp  de addp  hl addp                     de addp  hl addp  hl addp  hl addp  hl addp  de addp            h inc  hl incp                                                  os-seed sthl                                                    jppushhl   end-code                                           : zh-random  ( n1 -- n2 )  zh-rnd um* nip  ;                    need rng-benchmark                                              : zh-rng-benchmark  ( -- )                                        s" Z80 Heaven" ['] zh-random rng-benchmark  ;                                                                                                                                                 ( random-byte )                                                 code random-byte  ( -- b )                                        ED c, 5F c,     \ ld a,r                                        C3 c, pusha ,   \ jp pusha                                      end-code                                                      need bench{                                                     : random-byte-test  ( -- )                                        ['] random-byte ['] rng defer!  cls  bench{ pixels              do  rng rng 192 min set-pixel  loop  }bench.                    ." Z80 R register" cr key drop ;                                                                                                                                                                                                                                                                                                                                                                                                                              ( lcm-random )                                                  need d*  need du/mod  need 2nip                                 2variable 2seed                                                 2147483647. 2constant max32                                     : lcm-rnd  ( -- d )                                               2seed 2@ 16807. d*                                              max32 du/mod  2nip                                              2dup 2seed 2!  ;                                              : lcm-random  ( n1 -- n2 )  lcm-rnd d>s um* nip  ;              need rng-benchmark                                              : lcm-rng-benchmark  ( -- )                                       s" LCM" ['] lcm-random rng-benchmark  ;                                                                                                                                                                                                                                                                                       ( all-rng-benchmarks )                                          need rng-benchmark  need +thru  1 4 +thru                       ' rng8-benchmark2 ' rng-benchmark defer!                        jw-rng-benchmark                                                mb1-rng-benchmark                                               mb2-rng-benchmark                                               zh-rng-benchmark                                                ' rng8-benchmark1 ' rng-benchmark defer!                        jw-rng-benchmark                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( jw-crnd )                                                     need os-seed                                                    code jw-crnd  ( -- b )                                            os-seed fthl                                                    ED c, 5F c,  a d ld  m e ld                                     de addp  l add  h xor                                           os-seed sthl                                                    pusha jp                                                        end-code                                                      need rng-benchmark                                              : jw-rng-benchmark  ( -- )                                        s" Joe Wingbermuehle" ['] jw-crnd rng-benchmark  ;                                                                                                                                                                                                                                                                            ( mb1-crandom )                                                 need z80-asm  need os-seed                                      code mb1-crnd  ( -- b )                                           os-seed fta                                                     a d ld  a add  a add  d add                                     a inc  os-seed sta                                              pusha jp                                                        end-code                                                      : mb1-crandom  ( n1 -- n2 )  mb1-crnd um* nip  ;                need rng-benchmark                                              : mb1-rng-benchmark  ( -- )                                       s" Milos Bazelides 1" ['] mb1-crnd rng-benchmark  ;                                                                                                                                                                                                                                                                           ( mb2-crandom )                                                 need z80-asm  need os-seed                                      code mb2-crnd  ( -- b )                                           os-seed fta                                                     a d ld  a add  a add  d add                                     07 add#  os-seed sta                                            pusha jp  end-code                                            : mb2-crandom  ( n1 -- n2 )  mb2-crnd um* nip  ;                need rng-benchmark                                              : mb2-rng-benchmark  ( -- )                                       s" Milos Bazelides 2" ['] mb2-crnd rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                           ( zh-crnd )                                                     code zh-crnd  ( -- b )                                            os-seed fta  a e ld                                             a add  e add  a add  a add  e add  #83 add#                     os-seed sta                                                     pusha jp                                                        end-code                                                      need rng-benchmark                                              : zh-rng-benchmark  ( -- )                                        s" Z80 Heaven (8 bit)" ['] zh-crnd rng-benchmark  ;                                                                                                                                                                                                                                                                                                                                                                                                           ( columns rows )                                                need value                                                      32 value columns  24 value rows                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( set-banked-mode-output )                                      need set-mode-output                                            0 constant (output-routine)                                     code (banked-mode-output)  ( -- )                                 C5 c,                 \ push bc ; save Forth IP                 CD c, 0 ,             \ call output_routine ; to be patched     here cell- ' (output-routine) >body !                           C1 c,                 \ pop bc ; restore Forth IP               DD c, 21 c, next ,    \ ld ix,next ; restore IX, just in case   jpnext  end-code                                              : set-banked-mode-output  ( a -- )                                (output-routine) !  \ patch `(banked-mode-output)`              ['] (banked-mode-output) set-mode-output  ;                                                                                                                                                                                                                   ( set-mode-output set-font )                                    need os-chars  need os-chans                                    : set-mode-output  ( a -- )                                       os-chans @ 2dup ! 2dup 5 + ! 15 + !  ;                        : set-font  ( a -- )  os-chars !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( bleep )  \ ==sound48==                                        code bleep  ( duration pitch -- )                                 E1 c, D1 c, C5 c,   \ pop hl / pop de / push bc                 CD c, 03B5 ,        \ call rom_beeper                           C1 c,               \ pop bc                                    DD c, 21 c, next ,  \ ld ix,next ; restore ix                   jpnext              \ jp (ix)                                   end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( beep>bleep )                                                  : beep>bleep  ( frequency duration1 -- duration2 pitch )          over 1000 */ swap                                               4375 100 rot */ 30 -  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( laser-gun )                                                   need z80-asm                                                    code laser-gun  ( -- )                                            bc push                                                         5 b ld#                                                         0500 hl ldp#                                                    begin   0001 de ldp#                                                    hl push  03B5 call  hl pop  \ ROM beeper                        0010 de ldp#  de subp                                           jrnz                                                    bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                                                                                                                                                      ( white-noise )                                                 need z80-asm                                                    code white-noise  ( u -- )                                        de pop                                                          bc push  \ save the Forth IP                                    de bc ldp  0000 hl ldp#  \ bc=duration, hl=start of ROM         5C48 fta  a sra  a sra  a sra  07 and#  a d ld                  begin   m e ld  hl incp  bc decp  bc push                               08 b ld#  \ bit counter                                         begin   e a ld  10 and#  e rl  d or  FE out  \ beep                     step                                                    bc pop  bc tstp                                                 jrnz                                                    bc pop  jpnext \ restore the Forth IP and go next               end-code                                                                                                                      ( ambulance )                                                   need z80-asm                                                    code ambulance  ( n -- )                                          de pop  bc push  e b ld                                         begin   bc push  0320 hl ldp#  000A de ldp#                             <mark   hl push                                                         03B5 call  \ ROM beeper                                         hl pop  hl decp                                                 hl tstp                                                         jrnz                                                    bc pop                                                          step                                                    bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                      ( parse-escaped-string )                                        only forth definitions                                          need wid-of  need parse-char                                    vocabulary escaped-voc                                          wid-of escaped-voc constant escaped-wordlist                    also escaped-voc definitions                                    7 1 2constant a  8 1 2constant b  27 1 2constant e              12 1 2constant f  10 1 2constant l  13 1 2constant n            char " 1 2constant q  13 1 2constant r  9 1 2constant t         11 1 2constant v  0 1 2constant z                               char " 1 2constant "  char \ 1 2constant \                      : m  ( -- c1 c2 2 )  10 13 2  ;                                 : (x)  ( "c" -- n )                                               parse-char upper 16 digit? 0= #-260 ?throw  ;                 : x  ( "cc" -- c 1 )  (x) 16 * (x) + 1  ;                       -->                                                             ( parse-escaped-string )                                        only forth definitions  need char>string   need search-wordlist                         need chars>string  need s+              : unescape-char  ( c -- c1..cn n )                                dup char>string escaped-wordlist search-wordlist                if  nip execute  else  [char] \ 2  then  ;                    : parse-escaped-string  ( "ccc<quote>"  -- ca len )               0 0  \ dummy empty string to start with                         begin  parse-char dup [char] " <>  while  \ not finished?         dup [char] \ =  \ possibly escaped char?                        if    drop parse-char unescape-char                             else  1  then  chars>string s+                                repeat  drop  ;                                                                                                                                                                                                                                               ( s\" )                                                         need parse-escaped-string                                       : s\"  ( Interpretation: "ccc<quote>" -- ca len )                      ( Compilation: "ccc<quote>" -- )                                ( Run-time: -- ca len )                                    parse-escaped-string compiling? if  postpone sliteral  then     ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( .\" )                                                         need parse-escaped-string                                       : .\"  ( Compilation: "ccc<quote>" -- )                                ( Run-time: -- ca len )                                    compile (.")  parse-escaped-string s,                           ; immediate compile-only                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( s= )                                                          : s=  ( ca1 len1 ca2 len2 -- f )  compare 0=  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( sconstant )                                                   : sconstant  ( ca len "name" -- )                                 here >r s, r> count 2constant  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( char>string chars>string )                                    : char>string  ( c -- ca len )  1 allocate-string tuck c! 1  ;  : chars>string  ( c1..cn n -- ca len )                            dup if                                                            dup allocate-string swap 2dup 2>r  ( c1..cn ca n )              bounds do  i c!  loop  2r>                                    else  pad swap  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( +place )                                                      : +place  ( ca1 len1 ca2 )                                        2dup c@ + over c!  dup c@ 1+ + smove  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( s+ )                                                          [defined] lengths                                               ?\ : lengths   2over nip over  ;                                   ( ca1 len1 ca2 len2 -- ca1 len1 ca2 len2 len1 len2 )         : s+  ( ca1 len1 ca2 len2 -- ca3 len3 )                           lengths + >r           ( ca1 len2 ca2 len2 ) ( r: len3 )        r@ allocate-string >r  ( r: len3 ca3 )                          2 pick r@ +            ( ca1 len1 ca2 len2 len1+ca3 )           smove                  ( ca1 len1 )  \ 2nd string to buffer     r@ smove               \  1st string to buffer                  r> r>  ;                                                                                                                                                                                                                                                                                                                                                                                      ( hunt )                                                        : hunt  ( ca1 len1 ca2 len2 -- ca3 len3 )                         search 0= if  chars + 0  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( #spaces )                                                     need under+                                                     : #spaces  ( ca len -- +n )                                       0 rot rot  0 do  count bl = under+  loop  drop abs  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( #chars )                                                      : #chars  ( ca len c -- +n )                                      0 2swap 0 do                                                      ( c count ca ) count over = under+  loop  2drop abs  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( /name first-name trim last-name )                             : /name  ( ca1 len1 -- ca2 len2 ca3 len3 )                        bl skip 2dup bl scan  ;                                       : first-name  ( ca1 len1 -- ca2 len2 )  /name nip -  ;          : trim ( ca1 len1 -- ca2 len2 )  -leading -trailing  ;          : last-name  ( ca1 len1 -- ca2 len2 )                             trim                                                            begin  2dup bl scan bl skip dup                                 while  2nip  repeat  2drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( prefix? suffix? )                                             need s=  need [if]                                              [needed] prefix? [if]                                           : prefix?  ( ca1 len1 ca2 len2 -- f ) tuck 2>r min 2r> s=  ;    [then]                                                          [needed] suffix? [if]                                           : suffix? ( ca1 len1 ca2 len2 -- wf )                             2swap dup 3 pick - /string s=  ;                              [then]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( -prefix )                                                     need string-prefix?                                             : -prefix  ( ca1 len1 ca2 len2 -- ca1 len1 | ca3 len3 )           dup >r 2over 2swap string-prefix?                               if  swap r@ + swap r> -  else  rdrop  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( -suffix )                                                     need suffix?                                                    : -suffix ( ca1 len1 ca2 len2 -- ca1 len1 | ca3 len3 )            dup >r 2over 2swap suffix?                                      if  r> -  else  rdrop  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( ud>str d>str chop )                                           : ud>str  ( ud -- ca len )  <# #s #>  ;                         : d>str  ( ud -- ca len )  tuck dabs <# #s rot sign #>  ;       : chop  ( ca len -- ca' len' )  1- swap char+ swap  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( save-counted-string )                                         : save-counted-string  ( ca1 len1 -- ca2 )                        dup 1+ allocate-string dup >r place r>  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( os-chars os-chans os-flags2 os-seed os-frames os-udg )        [unneeded] os-chars    ?\ 23606 constant os-chars               [unneeded] os-chans    ?\ 23631 constant os-chans               [unneeded] os-flags2   ?\ 23658 constant os-flags2              [unneeded] os-seed     ?\ 23670 constant os-seed                [unneeded] os-frames   ?\ 23672 constant os-frames              [unneeded] os-udg      ?\ 23675 constant os-udg                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( ms )  \ ==time==                                              need os-frames                                                  : ms  ( u -- )                                                    20 / os-frames @ +                                              begin  dup os-frames @ u<  until drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ms88 )                                                        need z80-asm                                                    code ms88  ( u -- )                                               de pop                                                          begin \ .reMS:                                                  d a ld                                                          e or nz if                                                        de push \ push bc                                               #133 de ldp#                                                    begin  \ .reMS2:                                                  dec decp  d a ld  e or                                        z until \ jr nz,reMS2                                           de pop \ pop bc                                                 de decp  l dec                                               z until \ jr nz,reMS                                             then  jpnext  end-code                                        ( frames@ frames! reset-frames )                                need os-frames                                                  : frames@  ( -- d )                                               os-frames @ [ os-frames 2+ ] literal c@  ;                    : frames!  ( d -- )                                               [ os-frames 2+ ] literal c! os-frames !  ;                    : reset-frames  ( -- )  0. frames!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( pause )                                                       need z80-asm  need call-xt  need execute-hl                     code pause ( u -- )                                               de pop  bc push                                                 begin                                                             de push                                                         ' (wait) call-xt  hl pop  execute-hl                            de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need call-xt                                      defer (wait)  ' noop ' (wait) defer!                            code pause ( u -- )                                               de pop  bc push                                                 begin                                                             de push                                                         ' (wait) call-xt                                                de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need execute-hl                                   code pause ( u -- )                                               de pop  bc push                                                 begin                                                             de push                                                         (wait) fthl  execute-hl                                         de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need execute-hl                                   variable (wait)  ' noop (wait) !                                code pause ( u -- )                                               de pop  bc push                                                 begin                                                             de push                                                         ' (wait) >body fthl  execute-hl                                 de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need execute-hl                                   variable (wait)  ' noop (wait) !                                code pause ( u -- )                                               de pop  bc push                                                 begin                                                             de push                                                         ' (wait) >body fthl execute-hl                                  de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                      ( just-pause )                                                  need z80-asm                                                    code just-pause ( u -- )                                          de pop  bc push                                                 begin                                                             halt  de decp  de tstp  \ finished?                           z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( leapy-year? )                                                 : leapy-year?  ( n -- f )                                         dup 400 mod 0= if  drop true   exit  then                       dup 100 mod 0= if  drop false  exit  then                             4 mod 0= if       false  exit  then                       false  ;                                                      exit                                                            need baden-case                                                 : leapy-year?  ( n -- f )                                         case 400 mod 0= of  true   endof                                case 100 mod 0= of  false  endof                                case   4 mod 0= of  true   endof                                othercase false  ;                                                                                                                                                                                                                                            ( set-date get-date )                                           create (date)  1 c,  1 c,  2016 ,                               : get-date  ( -- day month year )                                 (date) c@                                                       [ (date) 1+ ] literal c@                                        [ (date) 2+ ] literal @  ;                                    : set-date  ( day month year -- )                                 [ (date) 2+ ] literal !                                         [ (date) 1+ ] literal c!                                        (date) !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( set-time get-time reset-time )                                need frames@  need frames!  need m+  need alias  need ud*       : get-time  ( -- second minute hour )                             frames@ 50 um/mod nip s>d   ( sec . )                                   60 um/mod s>d       ( sec min . )                               60 um/mod           ( sec min hour )  ;               : set-time  ( second minute hour -- )                             3600 um*  rot 60 * m+  rot m+  ( seconds )                      50. ud* frames!  ;                                            ' reset-frames alias reset-time  ( -- )                                                                                                                                                                                                                                                                                                                                                                                                                         ( .time .system-time .date .system-date .time&date time&date )  need get-time  need get-date                                    : .00  ( n -- )  s>d <# # # #> type  ;                          : .0000  ( n -- )  s>d <# # # # # #> type  ;                    : .time  ( second minute hour -- )                                .00 ':' emit .00 ':' emit .00  ;                              : .system-time  ( -- )  get-time .time  ;                       : .date  ( day month year -- )                                    .0000 '-' emit .00 '-' emit .00  ;                            : .system-date  ( -- )  get-date  .date  ;                      : .time&date  ( second minute hour day month year -- )            .date 'T' emit .time  ;                                       : time&date  ( -- second minute hour day month year )             get-time get-date  ;                                                                                                                                                                          ( list )                                                        need .line  need nuf?                                           : list  ( n -- )                                                  dup scr !                                                       cr ." Scr # " .                                                 l/scr 0 do                                                        cr i 2 .r space i scr @ .line                                   nuf? ?leave                                                   loop cr  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( index .index )                                                need .line  need nuf?                                           : .index  ( n -- )  cr dup 3 .r space 0 swap .line  ;           : index  ( n1 n2 -- )                                             1+ swap do                                                        cr i 3 .r space 0 i .line  nuf? ?leave                        loop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( index-like )                                                  need .index  need nuf?                                          [defined] contains                                                ?\ : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;  : index-like  ( n1 n2 "name" -- )                                 parse-name 2swap                                                1+ swap do                                                        0 i line>string 2over contains if  i .index  then               nuf? ?leave                                                   loop  2drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                ( index-ilike )                                                 need .index                                                     [defined] contains                                                ?\ : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;  : index-ilike  ( n1 n2 "name" -- )                                parse-name save-string 2dup uppers                              2swap 1+ swap do                                                  save-string  0 i line>string save-string 2dup uppers            2over contains if  i .index  then                               nuf? ?leave                                                   loop  2drop  ;                                                                                                                                                                                                                                                                                                                                                                                ( 2value 2to )                                                  : 2value  ( d "name"  -- )  2constant  ;                        : 2to  ( Interpretation: d "name" -- )                                 ( Compilation: "name" -- )                                 ' >body compiling? if    postpone literal postpone 2!                              else  2!  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( value to )                                                    : value  ( n "name"  -- )  constant  ;                          : to  ( Interpretation: n "name" -- )                                 ( Compilation: "name" -- )                                  ' >body compiling? if    postpone literal postpone !                               else  !  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( wid>link wid>name named-wid wid>vocabulary )                  need alias                                                      ' cell+ alias wid>link  ( wid -- a )                            : (wid>name)  ( wid -- a )  [ 2 cells ] literal +  ;            : wid>name  ( wid -- nt|0 )  (wid>name) @  ;                    : named-wid ( wid -- )  (wid>name) latest swap !  ;             : wid>vocabulary  ( wid "name" -- )                               create dup , named-wid                                          does>  ( -- )  ( pfa )  @ context !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( get-order order@ )                                            : order@  ( a -- u*wid u )                                        dup @ dup if    >r cell+  recurse  r> swap 1+ exit                        then  nip  ;                                        : get-order  ( -- u*wid u )  context order@ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( wid-of )                                                      : wid-of  ( "name" -- wid )  ' >body  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( swap-current trail )                                          [unneeded] trail                                                ?\ : trail  ( -- nt )  context @ @  ;                           [unneeded] swap-current ?\ exit                                 : swap-current  ( wid1 -- wid2 )                                  get-current swap set-current  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( find-name-in find )                                           : find-name-in  ( ca len wid -- nt | 0 )  @ find-name-from  ;   : find  ( ca -- ca 0 | xt 1 | xt -1 )                             dup count find-name dup                                         if  nip name>immediate? 1 or negate  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( nuclear-invaders )                                            \ Version 0.0.0+201603260017                                    \ Description                                                   \ This game is a ZX Spectrum port (for Solo Forth:              \ http://programandala.net/en.program.solo_forth.html) of a     \ game written by Dancresp in 2013 for Jupiter ACE              \ (http://www.zonadepruebas.com/viewtopic.php?t=4231).          \ Copyright (C) 2016 Marcos Cruz (programandala.net)            \ Copyright (C) 2013 Scainet Soft                               \ License                                                       \ You may do whatever you want with this work, so long as you   \ retain the copyright/authorship/acknowledgment/credit         \ notice(s) and this license in all redistributed copies and    \ derived works.  There is no warranty.                         -->                                                                                                                             ( Requirements)                                                 only forth definitions                                          need roll      need inkey   need bleep        need beep>bleep   need os-chars  need os-udg  need 2/           need abort"       need value     need case    need random       need columns      need rows      need ocr     need ms           need s+           need 2value    need row     need char>string  need s\"          need alias     need plot    need adraw                          4 constant /kk                                                  need kk-ports  need kk-1#   need pressed?     need kk-chars     [defined] binary  ?\ : binary  ( -- )  2 base !  ;              need defer                                                      need :noname  need benched    need ~~   13 ~~key !              -->                                                                                                                                                                                             ( Debug tools)                                                  defer (debug-point)  ' noop ' (debug-point) defer!              : debug-point  ( -- )                                             (debug-point)                                                   depth abort" Stack is not empty"                                ;                                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Screen) debug-point                                           16384 constant sys-screen  6912 constant /sys-screen                                       6144 constant /sys-screen-bitmap     22528 constant attributes  768 constant /attributes                  2 constant arena-top-y                                         21 constant tank-y                                          tank-y constant arena-bottom-y                                      23 constant status-bar-y                                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Colors) debug-point                                           0 constant black    1 constant blue   2 constant red            3 constant magenta  4 constant green  5 constant cyan           6 constant yellow   7 constant white                            : papery   ( color -- paper-attribute )           8 *  ;        : brighty  ( attribute -- brighty-attribute )   64 or  ;        : flashy   ( attribute -- flashy-attribute )   128 or  ;        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Colors) debug-point                                           : set-color  ( b -- )  23695 c!  ;                              : color  ( b "name" -- )                                          create c,  does> ( -- )  ( pfa ) c@ set-color  ;              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Colors) debug-point                                                         white color text-color                                          black color arena-color                            white papery red + color brick-color                                  blue brighty color tank-color                                           blue color life-color                                          green color invader-color                              yellow brighty color container-color                                    yellow color projectile-color                                  magenta color ufo-color                             : init-colors  ( -- )                                             0 paper 7 ink 0 flash 0 bright 0 inverse 1 border  ;          -->                                                                                                                                                                                                                                                             ( Variables) debug-point                                        variable tank-x        \ column                                 variable projectile-x  \ column                                 variable projectile-y  \ row, 0 if no shoot                     variable ufo-x         \ column                                 variable lifes         \ counter (0..3)                         variable level         \ counter (1..5)                         variable score         \ counter                                variable record        \ max score                              variable invaders      \ counter (all units of every type)      variable invader-type  \ element of table  (0..9)               variable catastrophe   \ flag (game end condition)              record off                                                      -->                                                                                                                                                                                             ( Keyboard) debug-point                                         13 constant enter-key                                           0 value kk-left#    0 value kk-right#    0 value kk-fire#       0. 2value kk-left   0. 2value kk-right   0. 2value kk-fire      : wait  ( -- )  begin  inkey  until  ;                          : enter-key?  ( -- f )  inkey enter-key =  ;                    : wait-for-enter  ( -- )  begin  enter-key?  until  ;           -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( kk#>c kk#>string )                                            : kk#>c  ( n -- c )  kk-chars + c@  ;                           : kk#>string  ( n -- ca len )                                     case  kk-en# of  s" Enter"         endof                              kk-sp# of  s" Space"         endof                              dup kk#>c upper char>string rot  \ default                endcase  ;                                                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( controls )                                                    3 constant /controls                                            create controls  here                                               kk-5# c,  kk-8# c,  kk-en# c,   \ cursor with Enter             kk-r# c,  kk-t# c,  kk-en# c,   \ Spanish Dvorak keyboard       kk-z# c,  kk-x# c,  kk-en# c,   \ from the original game        kk-5# c,  kk-8# c,  kk-0#  c,   \ cursor joystick               kk-5# c,  kk-8# c,  kk-sp# c,   \ cursor with Space             kk-1# c,  kk-2# c,  kk-5#  c,   \ Sinclair joystick 1           kk-6# c,  kk-7# c,  kk-0#  c,   \ Sinclair joystick 2           kk-o# c,  kk-p# c,  kk-q#  c,   \ QWERTY                        kk-n# c,  kk-m# c,  kk-q#  c,   \ QWERTY                        kk-q# c,  kk-w# c,  kk-p#  c,   \ QWERTY                        kk-z# c,  kk-x# c,  kk-p#  c,   \ QWERTY                    here swap - /controls / constant max-controls                   max-controls 1- constant last-control  -->                      ( next-controls )                                               : >controls  ( n -- a )  /controls * controls +  ;              : #>kk  ( n -- d )  /kk * kk-ports + kk@  ;                     : set-controls  ( n -- )                                          >controls     dup c@  dup to kk-left#   #>kk 2to kk-left                   1+ dup c@  dup to kk-right#  #>kk 2to kk-right                  1+     c@  dup to kk-fire#   #>kk 2to kk-fire  ;   variable current-controls                                       current-controls off                                            current-controls @ set-controls                                 : next-controls  ( -- )                                           current-controls @ 1+  dup last-control > 0= abs *              dup current-controls !  set-controls  ;                       -->                                                                                                                                                                                             ( beep ) debug-point                                            : beep  ( n1 n2 -- )  beep>bleep bleep  ;                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( udg-set udg>bitmap >scan scan! ) debug-point                          $80 constant first-udg  \ first UDG code in Solo Forth          $FF constant last-udg   \ last UDG code in Solo Forth           128 constant udgs       \ number of UDGs \ XXX TMP --             8 constant /udg       \ bytes per UDG                 udgs /udg * constant /udg-set   \ size of the UDG set in bytes  create udg-set /udg-set allot                                   udg-set os-udg !                                                : udg>bitmap  ( c -- a )  first-udg - /udg * udg-set +  ;       : >scan  ( n c -- a )  udg>bitmap +  ;                          : scan!  ( c b n -- c )  rot >scan c!  ;                        variable used-udgs  used-udgs off                               : ?free-udg  ( n -- )                                             used-udgs +!  used-udgs @ udgs > abort" Too many UDGs"  ;     -->                                                                                                                             ( font! font@ rom-font ) debug-point                            : font!  ( a -- )  os-chars !  ;                                : font@  ( -- a )  os-chars @  ;                                variable ocr-first-udg                                          variable ocr-last-udg                                           : init-ocr  ( -- )                                                ocr-first-udg @ udg>bitmap ocr-charset !                        ocr-first-udg @ ocr-first !                                     ocr-last-udg @ ocr-first-udg @ - 1+ ocr-chars !  ;  \ chars   : rom-font  ( -- )  15360 font!  ;                              -->                                                                                                                                                                                                                                                                                                                                                                                             ( ~~ )                                                          warnings @  warnings off                                        variable ~~base                                                 : ~~(  ( -- )  base @ ~~base ! decimal  ;                       : ~~)  ( -- )  ~~base @ base !  ;                               : ~~  ( -- )                                                      postpone ~~( postpone ~~  postpone ~~)  ; immediate           ~~? off                                                         warnings !                                                      : XXX  ( -- )                                                     ~~? on                                                          base @ >r decimal latest .name .s r> base !                     key drop ;                                                    -->                                                                                                                                                                                             ( .score .record update-score  ) debug-point                     1 constant score-y                                             14 constant record-x                                            variable players  1 players !  \ XXX TODO -- not used yet       variable player   1 player !   \ XXX TODO -- not used yet       : score-x  ( -- x )  3 player @ 1- 22 * +  ;                    : (.score)  ( n x y -- )                                          at-xy s>d <# # # # # #> text-color type  ;                    : score-xy  ( -- x y )  score-x score-y  ;                      : at-score  ( -- )  score-xy at-xy  ;                           : .score  ( -- )  score @ score-xy (.score)  ;                  : .record  ( -- )  record @ record-x score-y (.score)  ;        : update-score  ( n -- )  score +! .score  ;                    -->                                                                                                                                                                                             ( latest-sprite-width latest-sprite-height )                        variable >udg  first-udg >udg !  \ next free UDG            variable latest-sprite-width                                    variable latest-sprite-height                                   variable latest-sprite-udg                                      : ?udg  ( c -- )  last-udg > abort" Too many UDGs"  ;           : free-udg  ( n -- c )                                            >udg @ dup latest-sprite-udg !                                  tuck +  dup >udg !  1- ?udg  ;                                : latest-sprite-size!  ( width height -- )                        latest-sprite-height !  latest-sprite-width !  ;              -->                                                                                                                                                                                                                                                                                                                             ( sprite-string )                                               : ?sprite-height  ( -- )                                          latest-sprite-height @ 1 >                                      abort" Sprite height not supported for sprite strings"  ;     : sprite-string  ( "name" -- )                                    ?sprite-height                                                  here latest-sprite-udg @  latest-sprite-width @ dup >r          0 ?do  dup c, 1+  loop  drop  r> 2constant  ;                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( 1x1sprite! 1x1sprite )                                        : (1x1sprite!)  ( b0..b7 c -- )                                   1 ?free-udg  1 1 latest-sprite-size!                            /udg 0 do                                                         dup /udg 1+ i - roll i scan!                                  loop  drop  ;                                                 : 1x1sprite!  ( b0..b7 -- )                                       1 free-udg (1x1sprite!)  ;                                    : 1x1sprite  ( n0..n7 "name" -- )                                 1 free-udg dup constant (1x1sprite!)  ;                        ' emit alias .1x1sprite   ( c -- )                             ' emits alias .1x1sprites  ( c n -- )                           -->                                                                                                                                                                                                                                                             ( 2x1sprite! 2x1sprite )                                        : (2x1sprite!)  ( n0..n7 c -- )                                   2 ?free-udg  2 1 latest-sprite-size!                            /udg 0 do                                                         dup /udg 1+ i - pick flip i scan! 1+  \ first UDG               dup /udg 1+ i - roll      i scan! 1-  \ second UDG            loop  drop  ;                                                 : 2x1sprite!  ( n0..n7 -- )                                       2 free-udg (2x1sprite!)  ;                                    : 2x1sprite  ( n0..n7 "name" -- )                                 2 free-udg dup constant (2x1sprite!)  ;                       : .2x1sprite  ( c -- )  dup emit 1+ emit  ;                     -->                                                                                                                                                                                                                                                             ( invader-1 invader-1$ ) debug-point                            2 constant udg/invader                                          >udg @ ocr-first-udg !                                          binary                                                          0000001111000000                                                0001111111111000                                                0011111111111100                                                0011100110011100                                                0011111111111100                                                0000011001100000                                                0000110110110000                                                0011000000001100                                                2x1sprite invader-1                                             sprite-string invader-1$  ( -- ca len )                         decimal  -->                                                                                                                    ( invader-1 ) debug-point                                       binary                                                          0000001111000000                                                0001111111111000                                                0011111111111100                                                0011100110011100                                                0011111111111100                                                0000111001110000                                                0001100110011000                                                0001100000011000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-1 ) debug-point                                       binary                                                          0000001111000000                                                0001111111111000                                                0011111111111100                                                0011100110011100                                                0011111111111100                                                0000111001110000                                                0001100110011000                                                0000110000110000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-1 ) debug-point                                       binary                                                          0000001111000000                                                0001111111111000                                                0011111111111100                                                0011100110011100                                                0011111111111100                                                0000111001110000                                                0001100110011000                                                0001100000011000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-2 invader-2$ ) debug-point                            binary                                                          0000100000100000                                                0000010001000000                                                0000111111100000                                                0001101110110000                                                0011111111111000                                                0011111111111000                                                0010100000101000                                                0000011011000000                                                2x1sprite invader-2                                             sprite-string invader-2$  ( -- ca len )                         decimal  -->                                                                                                                                                                                                                                                    ( invader-2 ) debug-point                                       binary                                                          0000100000100000                                                0000010001000000                                                0000111111100000                                                1111101110111110                                                0011111111111000                                                0001111111110000                                                0000100000100000                                                0001000000010000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-2 ) debug-point                                       binary                                                          0000100000100000                                                0010010001001000                                                0010111111101000                                                0011101110111000                                                0011111111111000                                                0001111111110000                                                0000100000100000                                                0001000000010000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-2 ) debug-point                                       binary                                                          0000100000100000                                                0000010001000000                                                0000111111100000                                                1111101110111110                                                0011111111111000                                                0001111111110000                                                0000100000100000                                                0001000000010000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-3 invader-3$ ) debug-point                            binary                                                          0000000110000000                                                0000001111000000                                                0000011111100000                                                0000110110110000                                                0000111111110000                                                0000001001000000                                                0000010110100000                                                0000101001010000                                                2x1sprite invader-3                                             sprite-string invader-3$  ( -- ca len )                         decimal  -->                                                                                                                                                                                                                                                    ( invader-3 ) debug-point                                       binary                                                          0000000110000000                                                0000001111000000                                                0000011111100000                                                0000110110110000                                                0000111111110000                                                0000010110100000                                                0000100000010000                                                0000100000010000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-3 ) debug-point                                       binary                                                          0000000110000000                                                0000001111000000                                                0000011111100000                                                0000110110110000                                                0000111111110000                                                0000010110100000                                                0000100000010000                                                0000010000100000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( invader-3 ) debug-point                                       binary                                                          0000000110000000                                                0000001111000000                                                0000011111100000                                                0000110110110000                                                0000111111110000                                                0000010110100000                                                0000100000010000                                                0000100000010000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( ufo ufo$ ) debug-point                                        binary                                                          0000000000000000                                                0000011111100000                                                0001111111111000                                                0011111111111100                                                0110110110110110                                                1111111111111111                                                0011100110011100                                                0001000000001000                                                2x1sprite ufo                                                   sprite-string ufo$  ( -- ca len )                               decimal  -->                                                                                                                                                                                                                                                    ( ufo ) debug-point                                             binary                                                          0000000000000000                                                0000011111100000                                                0001111111111000                                                0011111111111100                                                0011011011011010                                                1111111111111111                                                0011100110011100                                                0001000000001000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( ufo ) debug-point                                             binary                                                          0000000000000000                                                0000011111100000                                                0001111111111000                                                0011111111111100                                                0101101101101100                                                1111111111111111                                                0011100110011100                                                0001000000001000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( ufo ) debug-point                                             binary                                                          0000000000000000                                                0000011111100000                                                0001111111111000                                                0011111111111100                                                0010110110110110                                                1111111111111111                                                0011100110011100                                                0001000000001000                                                2x1sprite!                                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( brick ) debug-point                                           binary                                                          11111011                                                        11111011                                                        11111011                                                        00000000                                                        11011111                                                        11011111                                                        11011111                                                        00000000                                                        1x1sprite brick                                                 >udg @ 1- ocr-last-udg !                                        decimal  -->                                                                                                                                                                                                                                                    ( broken-top-brick ) debug-point                                binary                                                          11111111                                                        11111111                                                        11111000                                                        11111100                                                        11100100                                                        10000000                                                        00000000                                                        00000000                                                        1x1sprite broken-top-brick                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( broken-bottom-brick ) debug-point                             binary                                                          00000000                                                        10000000                                                        10100000                                                        11100100                                                        11111100                                                        11111000                                                        11111101                                                        11111111                                                        1x1sprite broken-bottom-brick                                   decimal  -->                                                                                                                                                                                                                                                                                                                    ( tank$ ) debug-point                                           2 constant udg/tank                                             binary                                                          0000000100000000                                                0000001110000000                                                0000001110000000                                                0111111111111100                                                1111111111111110                                                1111111111111110                                                1111111111111110                                                1111111111111110                                                2x1sprite!                                                      sprite-string tank$  ( -- ca len )                              decimal  -->                                                                                                                                                                                    ( invader-explosion$ ) debug-point                              binary                                                          0000010001000000                                                0010001010001000                                                0001000000010000                                                0000100000100000                                                0110000000001100                                                0000010000100000                                                0001001010010000                                                0010010001001000                                                2x1sprite!                                                      sprite-string invader-explosion$  ( -- ca len )                 decimal  -->                                                                                                                                                                                                                                                    ( projectile ) debug-point                                      binary                                                          00000000                                                        00000001                                                        00000001                                                        00000001                                                        00000001                                                        00000001                                                        00000000                                                        00000000                                                        1x1sprite projectile                                            decimal  -->                                                                                                                                                                                                                                                                                                                    ( ufo-explosion$ ) debug-point                                  binary                                                          0000000000000010                                                0010000001100100                                                0100011111110000                                                0000111111111010                                                0001111011011001                                                0100110011110000                                                1000011111000100                                                0010001100010010                                                2x1sprite!                                                      sprite-string ufo-explosion$  ( -- ca len )                     decimal  -->                                                                                                                                                                                                                                                    ( ruler ) debug-point                                           binary                                                          00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        11111111                                                        00000000                                                        1x1sprite ruler                                                 decimal  -->                                                                                                                                                                                                                                                                                                                    ( container-top ) debug-point                                   binary                                                          0000001111100000                                                0001110000011100                                                0010001111100010                                                0010000000000010                                                0010000111000010                                                0010001111100010                                                0010000111000010                                                0010000010000010                                                2x1sprite container-top                                         decimal  -->                                                                                                                                                                                                                                                                                                                    ( broken-top-left-container ) debug-point                       binary                                                          00000000                                                        00011100                                                        00100010                                                        00100010                                                        00100010                                                        00100001                                                        00100001                                                        00100001                                                        1x1sprite broken-top-left-container                             decimal  -->                                                                                                                                                                                                                                                                                                                    ( broken-top-right-container) debug-point                       binary                                                          00000000                                                        00011100                                                        00100010                                                        00100010                                                        01000010                                                        01000010                                                        01000010                                                        10000010                                                        1x1sprite broken-top-right-container                            decimal  -->                                                                                                                                                                                                                                                                                                                    ( container-bottom ) debug-point                                binary                                                          0010010101010010                                                0010111101111010                                                0010111000111010                                                0010011000110010                                                0010000000000010                                                0001110000011100                                                0000001111100000                                                0000000000000000                                                2x1sprite container-bottom                                      decimal  -->                                                                                                                                                                                                                                                                                                                    ( broken-bottom-left-container) debug-point                     binary                                                          00000001                                                        00000111                                                        00011110                                                        00100110                                                        00100000                                                        00011100                                                        00000011                                                        00000000                                                        1x1sprite broken-bottom-left-container                          decimal  -->                                                                                                                                                                                                                                                                                                                    ( broken-bottom-right-container) debug-point                    binary                                                          11000000                                                        01110000                                                        00111100                                                        00110010                                                        00000010                                                        00011100                                                        11100000                                                        00000000                                                        1x1sprite broken-bottom-right-container                         decimal  -->                                                                                                                                                                                                                                                                                                                    ( graphic-bl graphic-space ) debug-point                        -->  \ XXX OLD                                                  binary                                                          00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        00000000                                                        1x1sprite graphic-bl                                            : graphic-space  ( -- )  graphic-bl .1x1sprite  ;               decimal  -->                                                                                                                                                                                    ( sprites ) debug-point                                         binary                                                          0000000000000000                                                0000000000001000                                                0000000000001100                                                0000111111111110                                                0000111111111111                                                0000111111111110                                                0000000000001100                                                0000000000001000                                                2x1sprite right-arrow                                           sprite-string right-arrow$  ( -- ca len )                       decimal  -->                                                                                                                                                                                                                                                    ( sprites ) debug-point                                         binary                                                          0000000000000000                                                0001000000000000                                                0011000000000000                                                0111111111110000                                                1111111111110000                                                0111111111110000                                                0011000000000000                                                0001000000000000                                                2x1sprite left-arrow                                            sprite-string left-arrow$  ( -- ca len )                        decimal  -->                                                                                                                                                                                                                                                    ( sprites ) debug-point                                         binary                                                          0000111111110000                                                0011000000001100                                                0011000000001100                                                0010111111110100                                                0010000000000100                                                0010000000000100                                                0010000000000100                                                1111111111111111                                                2x1sprite fire-button                                           sprite-string fire-button$  ( -- ca len )                       decimal  -->                                                                                                                                                                                                                                                    ( centered center-type )  debug-point                           : centered  ( len -- column )  columns swap - 2/  ;             : centered-at  ( row len -- )  centered swap at-xy  ;           : center-type  ( ca len row -- )  over centered-at type  ;      : type-blank  ( ca len -- )  nip spaces  ;                      : center-type-blank  ( ca len row -- )                            over centered-at type-blank ;                                 17 constant message-y  \ row for game messages                  : message  ( ca len -- )                                          2dup message-y text-color center-type  1500 ms                       message-y center-type-blank  ;                           -->                                                                                                                                                                                                                                                                                                                             ( instructions ) debug-point                                    : title  ( -- )  s" NUCLEAR INVADERS" 0 center-type  ;          : (c)  ( -- )  127 emit  ;                                      : .copyright  ( -- )                                              row                                                             1 over    at-xy (c) ."  2013 Scainet Soft"                      1 over 1+ at-xy (c) ."  2016 Marcos Cruz"                       8 swap 2+ at-xy           ." (programandala.net)"  ;          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( instructions ) debug-point                                    : left-key$   ( -- ca len )  kk-left# kk#>string  ;             : right-key$  ( -- ca len )  kk-right# kk#>string  ;            : fire-key$   ( -- ca len )  kk-fire# kk#>string  ;             : controls$  ( -- ca len )                                        left-arrow$ left-key$ s+                                        s"   " s+ fire-key$ s+ s"   " s+                                right-key$ s+ right-arrow$ s+  ;                              : .controls  ( -- )                                               s" [Space] to change controls:" row dup >r center-type          fire-button$ r@ 2+ center-type                                  0 r@ 3 + at-xy columns spaces                                   controls$ r> 3 + center-type  ;                               -->                                                                                                                                                                                             ( instructions ) debug-point                                    : .score-table-item  ( ca1 len1 ca2 len2 -- )                     type text-color ."  = " type  ;                               9 constant score-table-x                                        : .score-table  ( -- )                                            score-table-x row                                               2dup     at-xy s" 10 points"                                             invader-color invader-1$ .score-table-item             2dup 2+  at-xy s" 20 points"                                             invader-color invader-2$ .score-table-item             2dup 4 + at-xy s" 30 points"                                             invader-color invader-3$ .score-table-item                  6 + at-xy s" bonus"                                                 ufo-color ufo$ .score-table-item  ;                  -->                                                                                                                             ( instructions ) debug-point                                    : at-controls  ( -- )  0 12 at-xy  ;                            : show-controls  ( -- )  at-controls .controls  ;               : menu  ( -- )                                                    begin                                                             break-key? if  quit  then  \ XXX TMP                            key                                                             dup enter-key = if  drop exit  then                                        bl = if  next-controls show-controls  then         again  ;                                                      -->                                                                                                                                                                                                                                                                                                                                                                                             ( instructions ) debug-point                                    : instructions  ( -- )                                            text-color  cls  title                                          0 3 at-xy .score-table                                          show-controls                                                   s" [Enter] to start" 18 center-type                             0 21 at-xy .copyright                                           menu  ;                                                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( game-screen ) debug-point                                     arena-bottom-y arena-top-y - 1+ columns * constant /arena       arena-top-y columns * attributes + constant arena-top-attribute : black-arena  ( -- )  arena-top-attribute /arena erase  ;      : wipe-arena  ( -- )  0 arena-top-y at-xy /arena spaces  ;      : -arena  ( -- )  black-arena wipe-arena  ;                     : score-bar$  ( -- ca len )                                       text-color s"  SCORE<1>    RECORD    SCORE<2>"  ;             : score-bar  ( -- )                                               home score-bar$ type .score .record  ;                        : show-player  ( -- )                                             10 0 do  at-score 4 spaces 64 ms  .score 64 ms  loop  ;       -->                                                                                                                                                                                                                                                             ( game-screen ) debug-point                                     : row>pixel  ( n1 -- n2 )  8 * 191 swap -  ;                    : bar-ruler  ( -- )                                               text-color                                                      [ tank-y row>pixel 8 - ] literal                                0 over plot  255 swap adraw  ;                                : at-lifes  ( -- )  0 status-bar-y at-xy  ;                     : .lifes  ( -- )                                                  at-lifes life-color                                             lifes @ 0 ?do  tank$ type  loop  ."   "  ;                    : status-bar  ( -- )  bar-ruler .lifes  ;                       : game-screen  ( -- )  init-colors cls score-bar status-bar  ;  -->                                                                                                                                                                                                                                                             ( udg/invader invaders-min-x invaders-max-x ) debug-point                           0 constant invaders-min-x                   columns udg/invader - constant invaders-max-x                   -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invaders-data ) debug-point                                        10 constant invader-types                                  6 cells constant /invader-type                                  create default-invaders-data                                    here                                                                3 ,     0 ,      5 , invaders-min-x ,  invader-3 ,   1 ,        3 ,     0 ,      7 , invaders-min-x ,  invader-2 ,   1 ,        3 ,     0 ,      9 , invaders-min-x ,  invader-2 ,   1 ,        3 ,     0 ,     11 , invaders-min-x ,  invader-1 ,   1 ,        3 ,     0 ,     13 , invaders-min-x ,  invader-1 ,   1 ,        3 ,     0 ,      5 , invaders-max-x ,  invader-3 ,  -1 ,        3 ,     0 ,      7 , invaders-max-x ,  invader-2 ,  -1 ,        3 ,     0 ,      9 , invaders-max-x ,  invader-2 ,  -1 ,        3 ,     0 ,     11 , invaders-max-x ,  invader-1 ,  -1 ,        3 ,     0 ,     13 , invaders-max-x ,  invader-1 ,  -1 ,    here swap - constant /invaders-data  -->                        ( invaders-data ) debug-point                                   create invaders-data  /invaders-data allot                      : >invader   ( -- n )  invader-type @ /invader-type *  ;        : 'invader   ( -- a )  >invader invaders-data +  ;              : 'default-invader   ( -- a )                                     >invader default-invaders-data +  ;                           : invader-units   ( -- a )  'invader            ;               : invader-active  ( -- a )  'invader cell+      ;               : invader-y       ( -- a )  'invader [ 2 cells ] literal +  ;   : invader-x       ( -- a )  'invader [ 3 cells ] literal +  ;   : invader-xy@    ( -- x y )  invader-y 2@  ;                    : invader-char@  ( -- c )  'invader [ 4 cells ] literal + @  ;  : invader-x-inc@  ( -- n )  'invader [ 5 cells ] literal + @  ; : invader-default-x@    ( -- x y )                                'default-invader [ 3 cells ] literal + @  ;                   -->                                                             ( set-building-size ) debug-point                                4 constant building-top-y                                      15 constant building-bottom-y                                   variable building-width                                         variable building-left-x     variable building-right-x          variable containers-left-x   variable containers-right-x        : set-building-size  ( -- )                                       level @ 2* 2+  building-width !                                 [ columns 2/ 1- ] literal \ half of the screen                  level @ \ half width of all containers                          2dup 1- - containers-left-x !                                   2dup    - building-left-x !                                     2dup    + containers-right-x !                                       1+ + building-right-x !  ;                               -->                                                                                                                             ( increase-level update-level init-level ) debug-point          5 constant max-level                                            : increase-level  ( -- )  level @ 1+ max-level min level !  ;   : update-level  ( -- )  increase-level set-building-size  ;     : init-level  ( -- )  level off  update-level  ;                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( building ) debug-point                                        : floor  ( y -- )                                                 building-left-x @ swap at-xy                                    brick-color brick building-width @ .1x1sprites  ;             : building-top  ( -- )  building-top-y floor  ;                 : building-bottom  ( -- )  building-bottom-y  floor  ;          : containers-bottom  ( n -- )                                     container-color                                                 0 ?do  container-bottom .2x1sprite  loop  ;                   : containers-top  ( n -- )                                        container-color                                                 0 ?do  container-top .2x1sprite  loop  ;                      -->                                                                                                                                                                                                                                                             ( building ) debug-point                                        : .brick  ( -- )  brick-color brick .1x1sprite  ;               : building  ( -- )                                                building-bottom                                                 level @  building-left-x @                                      building-top-y [ building-bottom-y 2- ] literal                 do                                                                2dup i 1+ at-xy .brick containers-bottom .brick                 2dup i    at-xy .brick containers-top    .brick               -2 +loop  2drop  building-top  ;                              -->                                                                                                                                                                                                                                                                                                                                                                                             ( drive ) debug-point                                                               1 constant tank-min-x                       columns udg/tank - 1- constant tank-max-x                       : tank-range  ( column -- column' )                               tank-max-x min tank-min-x max  ;                              : ?space   ( -- )  column if  text-color space  then  ;         : moving-tank?  ( -- -1|0|1 )                                     kk-left pressed? kk-right pressed? abs +  ;                   : .tank  ( -- )  tank-color tank$ type  ;                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( drive ) debug-point                                           : at-tank  ( -- )  tank-x @ tank-y at-xy  ;                     : tank-ready  ( -- )  at-tank .tank  ;                          : -tank  ( -- )  at-tank text-color 2 spaces  ;                 : move-tank  ( -1|1 -- )                                          tank-x @ + tank-range dup tank-x ! tank-y at-xy  ;            : drive  ( -- )                                                   moving-tank? ?dup 0= ?exit  -tank move-tank .tank  ;          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( init ) debug-point                                            : init-game  ( -- )                                               init-ocr  3 lifes !  init-level  score off  game-screen  ;    : init-invaders-data  ( -- )                                      default-invaders-data invaders-data /invaders-data move  ;    : init-ufo  ( -- )  -200 ufo-x !  ;                             : total-invaders  ( -- n )                                        0   invader-types 0 do                                                i invader-type ! invader-units @ +                            loop  ;                                                   : init-invaders  ( -- )                                           init-invaders-data  invader-type off                            total-invaders invaders !  ;                                  : init-tank  ( -- )                                               columns udg/tank - 2/ tank-x !  \ middle of the screen          projectile-y off  ;  -->                                      ( init ) debug-point                                            : parade  ( -- )                                                  invader-color                                                   invader-1 dup invader-2 dup invader-3                           building-bottom-y [ building-top-y 1+ ] literal                 do                                                                invaders-min-x i at-xy dup .2x1sprite                           invaders-max-x i at-xy     .2x1sprite                         2 +loop  ;                                                    : init-arena  ( -- )   -arena building tank-ready parade  ;     : level-message  ( -- ca len )                                    text-color s" LEVEL " level @ s>d <# # #> s+  ;               : show-level  ( -- ) level-message message  ;                   : init-combat  ( -- )                                             catastrophe off init-invaders init-ufo init-tank init-arena     show-level show-player  ;  -->                                ( invasion ) debug-point                                        : at-invader  ( -- )  invader-xy@ at-xy  ;                      4 constant frames/invader                                       : sprite>frame  ( c1 x -- c2 )                                    frames/invader mod udg/invader * +  ;                         : invader-frame  ( -- c )                                         invader-char@ invader-x @ sprite>frame  ;                     : .invader  ( -- )  invader-color invader-frame .2x1sprite  ;   -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invasion )                                                    variable broken-wall-x                                          : flying-to-the-right?  ( -- f )  invader-x-inc@ 0>  ;          red papery c,  here  red c,  constant broken-brick-colors       : broken-wall-color  ( -- )                                       broken-brick-colors flying-to-the-right? + c@ set-color  ;    : broken-bricks-coordinates  ( -- x1 y1 x2 y2 )                   broken-wall-x @ invader-y @ 1+  2dup 2-  ;                    : broken-left-wall  ( -- )                                        broken-bricks-coordinates                                       at-xy broken-bottom-brick .1x1sprite                            at-xy broken-top-brick  .1x1sprite  ;                         : broken-right-wall  ( -- )                                       broken-bricks-coordinates                                       at-xy broken-top-brick .1x1sprite                               at-xy broken-bottom-brick .1x1sprite  ;  -->                  ( invasion )                                                    : broken-wall  ( -- )                                             broken-wall-color flying-to-the-right?                          if  broken-left-wall  else  broken-right-wall  then  ;        : broken-wall?  ( -- f )                                          invader-x @ flying-to-the-right?                                if    1+ building-left-x                                        else  building-right-x                                          then  @ dup broken-wall-x ! =  ;                              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invasion )                                                    : broken-left-container  ( -- )                                   invader-x @ 2+ invader-y @ at-xy                                broken-top-right-container .1x1sprite                           invader-x @ 1+ invader-y @ 1+ at-xy                             broken-bottom-left-container .1x1sprite  ;                    : broken-right-container  ( -- )                                  invader-x @ 1- invader-y @ at-xy                                broken-top-left-container .1x1sprite                            invader-x @ invader-y @ 1+ at-xy                                broken-bottom-right-container .1x1sprite  ;                   -->                                                                                                                                                                                                                                                                                                                             ( invasion )                                                    : broken-container  ( -- )                                        container-color                                                 flying-to-the-right?  if    broken-left-container                                     else  broken-right-container  then  ;   : broken-container?  ( -- f )                                     invader-x @ flying-to-the-right?                                if    1+ containers-left-x                                      else     containers-right-x  then  @ =  ;                     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invasion )                                                    : damages  ( -- )                                                 broken-wall? if  broken-wall exit  then                         broken-container? dup if    broken-container                                          then  catastrophe !  ;                  : flying-invader  ( -- )                                          invader-x-inc@ dup 0>  \ flying to the right?                   if    at-invader text-color space .invader invader-x +!         else  invader-x +! at-invader .invader ?space  then  ;        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invasion ) debug-point                                        : activate-invader  ( -- )                                        32 random  26 invaders @ 5 < 16 * -  > invader-active !  ;    : last-invader-type?  ( -- f )                                    invader-type @ [ invader-types 1- ] literal =  ;              : next-invader  ( -- )                                            last-invader-type?                                              if  invader-type off  else  1 invader-type +!  then  ;        variable delay  50 delay !  \ ms                                : move-invader  ( -- )                                            delay @ ms  \ XXX TMP --                                        invader-active @                                                if  flying-invader damages  else  activate-invader  then  ;   : invasion  ( -- )                                                invader-units @ if  move-invader  then  next-invader  ;       -->                                                             ( ufo ) debug-point                                              3 constant ufo-y       \ row                                   27 constant ufo-max-x   \ column                                : ufo-invisible?  ( -- f )  ufo-x @ 0<  ;                       : at-ufo  ( -- )  ufo-x @ ufo-y at-xy  ;                        : -ufo  ( -- )  at-ufo 3 spaces init-ufo  ;                     : ufo-lost?  ( -- f )  ufo-x @ ufo-max-x >  ;                   : ufo-frame  ( -- c )  ufo ufo-x @ sprite>frame  ;              : flying-ufo  ( -- )                                              1 ufo-x +! at-ufo ufo-color space ufo-frame .2x1sprite  ;     : (move-ufo)  ( -- )                                              ufo-lost?  if  -ufo  else  flying-ufo  then  ;                : move-ufo  ( -- )                                                ufo-invisible? if  1 ufo-x +!  else  (move-ufo)  then  ;      -->                                                                                                                             ( ufo-impacted ) debug-point                                    : ufo-bang  ( -- )  18 12 do  i 15 beep  loop  ;                : ufo-on-fire  ( -- )                                             ufo-x @ 1+ ufo-y at-xy ufo-explosion$ type  ;                 : ufo-explosion  ( -- )  ufo-on-fire ufo-bang  ;                : ufo-points  ( -- n )  32 random 12 / 1+ 50 *  ;               : ufo-bonus  ( -- )                                               ufo-points dup ufo-x @ 1+ ufo-y at-xy .  update-score  ;      : ufo-impacted  ( -- )  ufo-explosion ufo-bonus 200 ms -ufo  ;  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( invader-impacted ) debug-point                                : invader-points  ( -- n )                                        projectile-y @ 3 - 2/          \ depending on the row           projectile-y @                                                  dup 5 = if  drop 30                                                     else  10 > 10 * 20 +  then  ;                         : invader-bonus  ( -- )  invader-points  update-score  ;        : invader-bang  ( -- ca len )  10 100 beep  ;                   : invader-on-fire  ( -- )                                         at-invader invader-explosion$ type  ;                         : -invader  ( -- )  at-invader 2 spaces  ;                      : invader-explosion  ( -- )                                       invader-on-fire invader-bang -invader  ;                      -->                                                                                                                                                                                             ( invader-impacted ) debug-point                                : impacted-invader  ( -- n )                                      projectile-y @ [ building-top-y 1+ ] literal - 2/               projectile-x @ [ columns 2/ ] literal > abs 5 * +  ;          : replace-invader  ( -- )                                         invader-active off                                              invader-default-x@ invader-x !  at-invader                      invader-color invader-char@ .2x1sprite  ;                     : current-invader-impacted  ( -- )                                invader-bonus invader-explosion                                 -1 invaders +!  -1 invader-units +!                             invader-units @ if  replace-invader  then  ;                  : invader-impacted  ( -- )                                        invader-type @ >r  impacted-invader invader-type !              current-invader-impacted  r> invader-type !  ;  -->                                                                           ( impact ) debug-point                                          : (impact)  ( -- )                                                projectile-y @ ufo-y = if  ufo-impacted exit  then              invader-impacted  ;                                           : impact  ( -- )                                                  projectile-y @ building-bottom-y <                              if  (impact)  then  projectile-y off  ;                       : projectile-xy  ( -- x y )  projectile-x @ projectile-y @  ;   : hit?  ( -- f )  projectile-xy ocr 0<>  ;                      : impact?  ( -- f )  hit? dup if  impact  then  ;               -->                                                                                                                                                                                                                                                                                                                                                                                             ( shoot ) debug-point                                           : at-projectile  ( -- )  projectile-xy at-xy  ;                 : .projectile  ( -- )                                             projectile-color at-projectile projectile .1x1sprite  ;       : fire-sound  ( -- )  ;                                         : fire  ( -- )                                                    tank-x @ projectile-x !                                         [ tank-y 1- ] literal projectile-y !  fire-sound  ;           : -projectile  ( -- )  at-projectile text-color space  ;        : projectile-lost?  ( -- f )                                      projectile-y @ building-top-y <  ;                            -->                                                                                                                                                                                                                                                                                                                             ( shoot ) debug-point                                           : shooted  ( -- )                                                 -projectile  projectile-lost? if  projectile-y off exit  then   -1 projectile-y +! impact? ?exit                                .projectile  ;                                                : shooted?  ( -- f )  projectile-y @ 0<>  ;                     : fire?  ( -- f )  kk-fire pressed?  ;                          : shoot  ( -- )                                                   shooted? if  shooted exit  then  fire? if  fire  then  ;      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( new-record? new-record check-record ) debug-point             : new-record?   ( -- f )  score @ record @ >  ;                 : new-record    ( -- f )  score @ record !  ;                   : check-record  ( -- )  new-record? if  new-record  then  ;     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( alive game-over next-level ) debug-point                      : .game-over  ( -- )  s" GAME OVER" message  ;                  : game-over  ( -- )  .game-over check-record  ;                 : next-level  ( -- )  update-level show-level  ;                : dead  ( -- )  -1 lifes +!  .lifes  ;                          : defeat-tune  ( -- )  100 200 do  i 20 beep  -5 +loop  ;       : defeat  ( -- )  defeat-tune  300 ms  dead  ;                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( run ) debug-point                                             : victory?  ( -- f )  invaders @ 0=  ;                          : (combat)  ( -- )                                                begin   victory? if  next-level init-combat  then                       break-key? if  quit  then  \ XXX TMP                            drive shoot move-ufo invasion  catastrophe @            until   defeat  ;                                             : combat  ( -- )  init-combat (combat)  ;                       : defeat?  ( f )  lifes @ 0=  ;                                 : game  ( -- )                                                    init-game  begin  combat defeat?  until  game-over  ;         : run  ( -- )  begin  instructions game  again  ;               -->                                                                                                                                                                                                                                                             ( Debugging tools)                                              : .udgs  ( -- )  cr udgs 0 do  i 128 + emit  loop  ;            : ni  ( -- )      next-invader  ;                               : m   ( -- )      move-invader broken-container? home .  ;      : in  ( -- )      init-game init-combat  ;                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Debugging tools)                                              : bc  ( -- )                                                      cls                                                             space broken-top-right-container .1x1sprite                     container-top .2x1sprite                                        broken-top-left-container .1x1sprite space cr                   container-bottom .2x1sprite 8 emit 8 emit                       broken-bottom-left-container .1x1sprite                         xy swap 1+ swap at-xy                                           container-bottom .2x1sprite                                     container-bottom .2x1sprite 8 emit                              broken-bottom-right-container .1x1sprite cr  ;                init-level                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      